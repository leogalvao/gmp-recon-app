{% extends "base.html" %}

{% block title %}Mappings Editor{% endblock %}

{% block content %}
<div class="card">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Mapping Editor</h1>
        <div class="flex items-center gap-4">
            <span class="text-sm text-gray-500">
                <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-1"></span> Auto-mapped
                <span class="inline-block w-3 h-3 bg-yellow-500 rounded-full mr-1 ml-3"></span> Suggested
                <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-1 ml-3"></span> Needs Review
            </span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="border-b mb-6">
        <nav class="flex space-x-4">
            <a href="/mappings?tab=budget_to_gmp" class="px-4 py-2 font-medium rounded-t-lg transition-colors {% if active_tab == 'budget_to_gmp' %}bg-blue-600 text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
                Budget → GMP
                {% if unmapped_budget %}<span class="ml-2 px-2 py-0.5 text-xs rounded-full {% if active_tab == 'budget_to_gmp' %}bg-blue-500{% else %}bg-red-100 text-red-800{% endif %}">{{ unmapped_budget|length }}</span>{% endif %}
            </a>
            <a href="/mappings?tab=direct_to_budget" class="px-4 py-2 font-medium rounded-t-lg transition-colors {% if active_tab == 'direct_to_budget' %}bg-blue-600 text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
                Direct Cost → Budget
                {% if unmapped_direct %}<span class="ml-2 px-2 py-0.5 text-xs rounded-full {% if active_tab == 'direct_to_budget' %}bg-blue-500{% else %}bg-red-100 text-red-800{% endif %}">{{ unmapped_direct|length }}</span>{% endif %}
            </a>
            <a href="/mappings?tab=allocation" class="px-4 py-2 font-medium rounded-t-lg transition-colors {% if active_tab == 'allocation' %}bg-blue-600 text-white{% else %}text-gray-600 hover:bg-gray-100{% endif %}">
                Regional Allocations
            </a>
        </nav>
    </div>

    {% if active_tab == 'budget_to_gmp' %}
    <!-- Budget to GMP Mapping -->
    <div class="space-y-6">
        <!-- Search/Filter -->
        <div class="flex gap-4 items-center">
            <div class="flex-1">
                <input type="text" id="searchBudget" placeholder="Search by budget code or description..."
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    onkeyup="filterTable('budgetTable', this.value)">
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">Side:</label>
                <select id="filterSide" onchange="applySideFilter(this.value)" class="border rounded-lg px-3 py-2">
                    <option value="">All Sides</option>
                    {% for s in available_sides %}
                    <option value="{{ s.value }}" {% if side_filter == s.value %}selected{% endif %}>{{ s.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">Show:</label>
                <select id="filterStatus" onchange="filterByStatus('budgetTable', this.value)" class="border rounded-lg px-3 py-2">
                    <option value="all">All Items ({{ total_budget }})</option>
                    <option value="unmapped" selected>Unmapped Only ({{ unmapped_budget|length }})</option>
                    <option value="mapped">Mapped Only ({{ mapped_budget|length }})</option>
                </select>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-4 gap-4 text-center">
            <div class="bg-blue-50 rounded-lg p-3">
                <div class="text-2xl font-bold text-blue-600">{{ total_budget }}</div>
                <div class="text-sm text-blue-700">Total Budget Codes</div>
            </div>
            <div class="bg-green-50 rounded-lg p-3">
                <div class="text-2xl font-bold text-green-600">{{ mapped_budget|length }}</div>
                <div class="text-sm text-green-700">Mapped</div>
            </div>
            <div class="bg-yellow-50 rounded-lg p-3">
                <div class="text-2xl font-bold text-yellow-600">{{ suggested_budget|length if suggested_budget else 0 }}</div>
                <div class="text-sm text-yellow-700">Have Suggestions</div>
            </div>
            <div class="bg-red-50 rounded-lg p-3">
                <div class="text-2xl font-bold text-red-600">{{ unmapped_budget|length }}</div>
                <div class="text-sm text-red-700">Needs Mapping</div>
            </div>
        </div>

        <!-- Mapping Table -->
        <div class="border rounded-lg overflow-hidden max-h-[600px] overflow-y-auto">
            <table class="w-full text-sm" id="budgetTable">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700 w-36">Budget Code</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Description</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700 w-20">Type</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700 w-64">GMP Division</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700 w-16">Side</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700 w-20">Method</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700 w-28">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for item in unmapped_budget %}
                    <tr class="hover:bg-blue-50 transition-colors" data-status="unmapped" data-code="{{ item['Budget Code'] }}" data-desc="{{ item['Budget Code Description']|default('', true) }}">
                        <td class="px-4 py-3">
                            <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">{{ item['Budget Code'] }}</span>
                        </td>
                        <td class="px-4 py-3 text-gray-600 text-sm">
                            <span title="{{ item['Budget Code Description']|default('', true) }}">
                                {{ (item['Budget Code Description'] | string)[:50] if item['Budget Code Description'] is not none and item['Budget Code Description'] == item['Budget Code Description'] else 'N/A' }}{% if (item['Budget Code Description']|default('')|string|length) > 50 %}...{% endif %}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-xs text-gray-500">{{ (item.get('Cost Type', '') | string)[:10] if item.get('Cost Type') is not none and item.get('Cost Type') == item.get('Cost Type') else '' }}</span>
                        </td>
                        <td class="px-4 py-3">
                            <select class="gmp-select w-full border rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-blue-500"
                                    data-budget-code="{{ item['Budget Code'] }}"
                                    onchange="enableSaveButton(this)">
                                <option value="">-- Select GMP Division --</option>
                                {% if item.get('suggested_gmp') %}
                                <option value="{{ item['suggested_gmp'] }}" class="bg-yellow-100" selected>
                                    ★ {{ item['suggested_gmp'] }} ({{ item.get('suggestion_confidence', 0)|int }}%)
                                </option>
                                {% endif %}
                                {% for gmp in gmp_options %}
                                {% if gmp != item.get('suggested_gmp') %}
                                <option value="{{ gmp }}">{{ gmp }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <select class="side-select border rounded px-1 py-0.5 text-xs"
                                    data-budget-code="{{ item['Budget Code'] }}">
                                <option value="BOTH" selected>Both</option>
                                <option value="EAST">East</option>
                                <option value="WEST">West</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-700">unmapped</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="saveMapping(this, 'budget_to_gmp')"
                                    class="save-btn px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    disabled>
                                Save
                            </button>
                        </td>
                    </tr>
                    {% endfor %}

                    {% for item in mapped_budget %}
                    <tr class="bg-green-50 hover:bg-green-100 transition-colors" data-status="mapped" data-code="{{ item['Budget Code'] }}" data-desc="{{ item['Budget Code Description']|default('', true) }}">
                        <td class="px-4 py-3">
                            <span class="font-mono text-xs bg-green-200 px-2 py-1 rounded">{{ item['Budget Code'] }}</span>
                        </td>
                        <td class="px-4 py-3 text-gray-600 text-sm">
                            <span title="{{ item['Budget Code Description']|default('', true) }}">
                                {{ (item['Budget Code Description'] | string)[:50] if item['Budget Code Description'] is not none and item['Budget Code Description'] == item['Budget Code Description'] else 'N/A' }}{% if (item['Budget Code Description']|default('')|string|length) > 50 %}...{% endif %}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-xs text-gray-500">{{ (item.get('Cost Type', '') | string)[:10] if item.get('Cost Type') is not none and item.get('Cost Type') == item.get('Cost Type') else '' }}</span>
                        </td>
                        <td class="px-4 py-3">
                            <select class="gmp-select w-full border border-green-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 bg-white"
                                    data-budget-code="{{ item['Budget Code'] }}"
                                    data-original="{{ item['gmp_division'] }}"
                                    onchange="enableEditButton(this)">
                                {% for gmp in gmp_options %}
                                <option value="{{ gmp }}" {% if gmp == item['gmp_division'] %}selected{% endif %}>{{ gmp }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <select class="side-select border border-green-300 rounded px-1 py-0.5 text-xs bg-white"
                                    data-budget-code="{{ item['Budget Code'] }}"
                                    data-original-side="{{ item.get('side', 'BOTH') }}"
                                    onchange="updateMappingSide(this, 'budget_to_gmp')">
                                <option value="BOTH" {% if item.get('side', 'BOTH') == 'BOTH' %}selected{% endif %}>Both</option>
                                <option value="EAST" {% if item.get('side') == 'EAST' %}selected{% endif %}>East</option>
                                <option value="WEST" {% if item.get('side') == 'WEST' %}selected{% endif %}>West</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-700" title="{{ item.get('mapping_method', '') }}">
                                {{ item.get('mapping_method', 'auto')[:8] }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex gap-1 justify-center">
                                <button onclick="saveMapping(this, 'budget_to_gmp')"
                                        class="save-btn px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed transition-colors hidden">
                                    Update
                                </button>
                                <button onclick="deleteMapping('{{ item['Budget Code'] }}', 'budget_to_gmp')"
                                        class="delete-btn px-2 py-1 text-red-600 hover:text-red-800 text-xs hover:bg-red-50 rounded">
                                    Remove
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Load More Button for Budget→GMP -->
        {% if has_more_budget %}
        <div id="budgetLoadMoreContainer" class="flex justify-center items-center gap-4 py-4 border-t">
            <button onclick="loadMoreBudgetItems()" id="loadMoreBudgetBtn"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Load More
            </button>
            <span class="text-sm text-gray-500" id="budgetLoadedCount">
                Showing {{ unmapped_budget|length }} of {{ total_unmapped_budget }} unmapped items
            </span>
        </div>
        {% endif %}

        {% if unmapped_budget %}
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-500">
                {{ total_unmapped_budget }} items need mapping
            </span>
            <button onclick="acceptAllSuggested()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                Accept All Suggestions ({{ suggested_budget|length }})
            </button>
        </div>
        {% endif %}
    </div>

    {% elif active_tab == 'direct_to_budget' %}
    <!-- Direct Cost to Budget Mapping - Unified Table UI -->
    <div class="space-y-6">
        <!-- Search/Filter Controls -->
        <div class="flex flex-wrap gap-4 items-center">
            <div class="flex-1 min-w-64">
                <input type="text" id="searchDirect" placeholder="Search by vendor, cost code, name..."
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    onkeyup="filterDirectTable(this.value)">
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">Side:</label>
                <select id="filterDirectSide" onchange="applySideFilter(this.value)" class="border rounded-lg px-3 py-2">
                    <option value="">All Sides</option>
                    {% for s in available_sides %}
                    <option value="{{ s.value }}" {% if side_filter == s.value %}selected{% endif %}>{{ s.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">Show:</label>
                <select id="filterDirectStatus" onchange="filterDirectByStatus(this.value)" class="border rounded-lg px-3 py-2">
                    <option value="all">All Items ({{ total_direct }})</option>
                    <option value="unmapped" selected>Unmapped Only ({{ unmapped_direct|length }})</option>
                    <option value="mapped">Mapped Only ({{ mapped_direct|length }})</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">Type:</label>
                <select id="filterType" onchange="filterByType(this.value)" class="border rounded-lg px-3 py-2">
                    <option value="all">All Types</option>
                    <option value="L">Labor</option>
                    <option value="M">Material</option>
                    <option value="S">Subcontract</option>
                    <option value="O">Other</option>
                </select>
            </div>
        </div>

        <!-- Score Breakdown Legend -->
        <div class="flex items-center gap-4 text-xs text-gray-500 bg-gray-50 rounded-lg px-3 py-2">
            <span class="font-medium text-gray-700">Score breakdown:</span>
            <span class="flex items-center gap-1">
                <div class="w-2 h-3 rounded-sm bg-blue-400"></div> Code Match
            </span>
            <span class="flex items-center gap-1">
                <div class="w-2 h-3 rounded-sm bg-purple-400"></div> Type Match
            </span>
            <span class="flex items-center gap-1">
                <div class="w-2 h-3 rounded-sm bg-green-400"></div> Text Similarity
            </span>
            <span class="flex items-center gap-1">
                <div class="w-2 h-3 rounded-sm bg-orange-400"></div> Historical
            </span>
            <span class="text-gray-400 ml-2">(darker = higher score)</span>
        </div>

        <!-- Progress Stats -->
        <div class="grid grid-cols-5 gap-4 text-center">
            <div class="bg-blue-50 rounded-lg p-3">
                <div class="text-2xl font-bold text-blue-600">{{ total_direct }}</div>
                <div class="text-sm text-blue-700">Total Items</div>
            </div>
            <div class="bg-green-50 rounded-lg p-3 border-2 border-green-200">
                <div class="text-2xl font-bold text-green-600">{{ mapped_direct|length }}</div>
                <div class="text-sm text-green-700">Mapped</div>
            </div>
            <div class="bg-emerald-50 rounded-lg p-3">
                <div class="text-2xl font-bold text-emerald-600">{{ direct_high|default(0) }}</div>
                <div class="text-sm text-emerald-700">High Conf.</div>
                <div class="text-xs text-emerald-500">≥85%</div>
            </div>
            <div class="bg-yellow-50 rounded-lg p-3">
                <div class="text-2xl font-bold text-yellow-600">{{ direct_medium|default(0) }}</div>
                <div class="text-sm text-yellow-700">Medium</div>
                <div class="text-xs text-yellow-500">60-84%</div>
            </div>
            <div class="bg-red-50 rounded-lg p-3">
                <div class="text-2xl font-bold text-red-600">{{ direct_low|default(0) }}</div>
                <div class="text-sm text-red-700">Needs Review</div>
                <div class="text-xs text-red-500">&lt;60%</div>
            </div>
        </div>

        <!-- Bulk Actions -->
        {% if direct_high|default(0) > 0 %}
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex justify-between items-center">
            <div>
                <span class="font-medium text-green-800">{{ direct_high }} items ready for bulk accept</span>
                <p class="text-sm text-green-600">High-confidence matches (≥85%) can be accepted automatically.</p>
            </div>
            <button onclick="bulkAcceptHighConfidence()" id="bulkAcceptBtn"
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Accept All High-Confidence
            </button>
        </div>
        {% endif %}

        <!-- Unified Mapping Table -->
        <div class="border rounded-lg overflow-hidden max-h-[600px] overflow-y-auto">
            <table class="w-full text-sm" id="directTable">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-3 py-3 text-left font-semibold text-gray-700">Vendor</th>
                        <th class="px-3 py-3 text-left font-semibold text-gray-700 w-28">Cost Code</th>
                        <th class="px-3 py-3 text-left font-semibold text-gray-700">Name</th>
                        <th class="px-3 py-3 text-right font-semibold text-gray-700 w-24">Amount</th>
                        <th class="px-3 py-3 text-center font-semibold text-gray-700 w-14">Type</th>
                        <th class="px-3 py-3 text-left font-semibold text-gray-700 w-64">Budget Code Mapping</th>
                        <th class="px-3 py-3 text-center font-semibold text-gray-700 w-16">Side</th>
                        <th class="px-3 py-3 text-center font-semibold text-gray-700 w-16">Status</th>
                        <th class="px-3 py-3 text-center font-semibold text-gray-700 w-24">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y" id="directTableBody">
                    <!-- Unmapped Items -->
                    {% for item in unmapped_direct %}
                    {% set conf_band = item.get('confidence_band', 'low') %}
                    {% set top_sugg = item.get('top_suggestion') %}
                    <tr class="hover:bg-blue-50 transition-colors {% if conf_band == 'high' %}bg-green-50{% elif conf_band == 'medium' %}bg-yellow-50{% endif %}"
                        data-status="unmapped"
                        data-dc-id="{{ item.get('direct_cost_id', '') }}"
                        data-code="{{ item.get('Cost Code', '') }}"
                        data-name="{{ item.get('Name', '') }}"
                        data-vendor="{{ item.get('Vendor', '') }}"
                        data-type="{{ item.get('Type', '') }}"
                        data-confidence="{{ item.get('confidence', 0) }}"
                        data-band="{{ conf_band }}">
                        {% set vendor_val = item.get('Vendor', '') %}
                        {% set vendor_str = vendor_val if vendor_val is string and vendor_val == vendor_val else '' %}
                        <td class="px-3 py-2 text-gray-600 max-w-32 truncate" title="{{ vendor_str }}">
                            {{ (vendor_str or 'N/A')[:20] }}
                        </td>
                        <td class="px-3 py-2">
                            <span class="font-mono text-xs bg-gray-100 px-1.5 py-0.5 rounded">{{ item.get('Cost Code', '') }}</span>
                        </td>
                        <td class="px-3 py-2 text-gray-600">
                            {% set name_val = item.get('Name', '') %}
                            {% set name_str = name_val if name_val is string and name_val == name_val else '' %}
                            <span class="truncate block max-w-48" title="{{ name_str }}">
                                {{ (name_str or 'N/A')[:35] }}{% if name_str|length > 35 %}...{% endif %}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-right font-mono text-sm">{{ item.get('Amount', '') }}</td>
                        <td class="px-3 py-2 text-center">
                            {% set type_code = item.get('Type', '') %}
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold
                                {% if type_code == 'L' %}bg-blue-100 text-blue-700
                                {% elif type_code == 'M' %}bg-purple-100 text-purple-700
                                {% elif type_code == 'S' %}bg-orange-100 text-orange-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ type_code or '?' }}
                            </span>
                        </td>
                        <td class="px-3 py-2">
                            <div class="flex items-center gap-2">
                                {% if top_sugg %}
                                {% set bd = top_sugg.get('breakdown', {}) %}
                                <div class="score-breakdown-inline shrink-0 cursor-help"
                                     title="Code: {{ (bd.get('code_match', 0) * 100)|int }}% | Type: {{ (bd.get('type_match', 0) * 100)|int }}% | Text: {{ (bd.get('text_sim', 0) * 100)|int }}% | History: {{ (bd.get('historical', 0) * 100)|int }}%">
                                    <div class="flex items-center gap-1">
                                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-bold shrink-0
                                            {% if conf_band == 'high' %}bg-green-100 text-green-800
                                            {% elif conf_band == 'medium' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-gray-100 text-gray-600{% endif %}">
                                            {{ item.get('confidence', 0)|int }}%
                                        </span>
                                        <div class="flex gap-0.5 items-center" title="Score breakdown: Code | Type | Text | History">
                                            <div class="w-1.5 h-3 rounded-sm {% if bd.get('code_match', 0) >= 0.8 %}bg-blue-500{% elif bd.get('code_match', 0) >= 0.4 %}bg-blue-300{% else %}bg-blue-100{% endif %}"
                                                 title="Code: {{ (bd.get('code_match', 0) * 100)|int }}%"></div>
                                            <div class="w-1.5 h-3 rounded-sm {% if bd.get('type_match', 0) >= 0.8 %}bg-purple-500{% elif bd.get('type_match', 0) >= 0.4 %}bg-purple-300{% else %}bg-purple-100{% endif %}"
                                                 title="Type: {{ (bd.get('type_match', 0) * 100)|int }}%"></div>
                                            <div class="w-1.5 h-3 rounded-sm {% if bd.get('text_sim', 0) >= 0.8 %}bg-green-500{% elif bd.get('text_sim', 0) >= 0.4 %}bg-green-300{% else %}bg-green-100{% endif %}"
                                                 title="Text: {{ (bd.get('text_sim', 0) * 100)|int }}%"></div>
                                            <div class="w-1.5 h-3 rounded-sm {% if bd.get('historical', 0) >= 0.8 %}bg-orange-500{% elif bd.get('historical', 0) >= 0.4 %}bg-orange-300{% else %}bg-orange-100{% endif %}"
                                                 title="History: {{ (bd.get('historical', 0) * 100)|int }}%"></div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 shrink-0">
                                    Manual
                                </span>
                                {% endif %}
                                <select class="budget-select flex-1 border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 min-w-80
                                    {% if conf_band == 'high' %}border-green-300{% elif conf_band == 'medium' %}border-yellow-300{% elif not top_sugg %}border-red-300{% endif %}"
                                        data-dc-id="{{ item.get('direct_cost_id', '') }}"
                                        data-cost-code="{{ item.get('Cost Code', '') }}"
                                        data-name="{{ item.get('Name', '') }}"
                                        data-vendor="{{ item.get('Vendor', '') }}"
                                        data-suggested="{{ top_sugg.get('budget_code', '') if top_sugg else '' }}"
                                        data-score="{{ item.get('confidence', 0) }}"
                                        data-original=""
                                        onchange="enableSaveButton(this)"
                                        aria-label="Select budget code">
                                    <option value="">-- Select Budget --</option>
                                    {% if top_sugg %}
                                    {% set sugg_desc = top_sugg.get('description', '') %}
                                    {% set sugg_desc_display = sugg_desc[:35] ~ '...' if sugg_desc|length > 35 else sugg_desc %}
                                    <option value="{{ top_sugg.get('budget_code', '') }}" selected class="font-medium" title="{{ sugg_desc }}">
                                        ★ {{ top_sugg.get('budget_code', '') }} – {{ sugg_desc_display or '(No description)' }} ({{ top_sugg.get('score', 0)|int }}%)
                                    </option>
                                    {% for sugg in item.get('suggestions', [])[1:] %}
                                    {% set alt_desc = sugg.get('description', '') %}
                                    {% set alt_desc_display = alt_desc[:30] ~ '...' if alt_desc|length > 30 else alt_desc %}
                                    <option value="{{ sugg.get('budget_code', '') }}" title="{{ alt_desc }}">
                                        {{ sugg.get('budget_code', '') }} – {{ alt_desc_display or '(No desc)' }} ({{ sugg.get('score', 0)|int }}%)
                                    </option>
                                    {% endfor %}
                                    <option disabled>──────────</option>
                                    {% endif %}
                                    {% for bc in budget_options %}
                                    {% if not top_sugg or bc.code != top_sugg.get('budget_code', '') %}
                                    <option value="{{ bc.code }}" title="{{ bc.description }}">{{ bc.display }}</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                                {% if top_sugg %}
                                <button onclick="showScoreBreakdown({{ item.get('direct_cost_id', 0) }})"
                                        class="text-gray-400 hover:text-blue-600 shrink-0" title="View score breakdown">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <select class="side-select border rounded px-1 py-0.5 text-xs"
                                    data-dc-id="{{ item.get('direct_cost_id', '') }}"
                                    data-cost-code="{{ item.get('Cost Code', '') }}"
                                    data-name="{{ item.get('Name', '') }}">
                                <option value="BOTH" selected>Both</option>
                                <option value="EAST">East</option>
                                <option value="WEST">West</option>
                            </select>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <span class="text-xs px-1.5 py-0.5 rounded bg-red-100 text-red-700">unmapped</span>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <div class="flex gap-1 justify-center">
                                {% if conf_band == 'high' and top_sugg %}
                                <button onclick="quickAccept(this)"
                                        class="quick-accept-btn px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors flex items-center gap-1"
                                        title="Accept {{ top_sugg.get('budget_code', '') }} ({{ item.get('confidence', 0)|int }}%)"
                                        data-budget-code="{{ top_sugg.get('budget_code', '') }}">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Accept
                                </button>
                                {% else %}
                                <button onclick="saveDirectMapping(this)"
                                        class="save-btn px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                        {% if not top_sugg %}disabled{% endif %}>
                                    Save
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Mapped Items -->
                    {% for item in mapped_direct %}
                    <tr class="bg-green-50 hover:bg-green-100 transition-colors"
                        data-status="mapped"
                        data-dc-id="{{ item.get('direct_cost_id', '') }}"
                        data-code="{{ item.get('Cost Code', '') }}"
                        data-name="{{ item.get('Name', '') }}"
                        data-vendor="{{ item.get('Vendor', '') }}"
                        data-type="{{ item.get('Type', '') }}"
                        data-band="mapped">
                        {% set vendor_val = item.get('Vendor', '') %}
                        {% set vendor_str = vendor_val if vendor_val is string and vendor_val == vendor_val else '' %}
                        <td class="px-3 py-2 text-gray-600 max-w-32 truncate" title="{{ vendor_str }}">
                            {{ (vendor_str or 'N/A')[:20] }}
                        </td>
                        <td class="px-3 py-2">
                            <span class="font-mono text-xs bg-green-200 px-1.5 py-0.5 rounded">{{ item.get('Cost Code', '') }}</span>
                        </td>
                        <td class="px-3 py-2 text-gray-600">
                            {% set name_val = item.get('Name', '') %}
                            {% set name_str = name_val if name_val is string and name_val == name_val else '' %}
                            <span class="truncate block max-w-48" title="{{ name_str }}">
                                {{ (name_str or 'N/A')[:35] }}{% if name_str|length > 35 %}...{% endif %}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-right font-mono text-sm">{{ item.get('Amount', '') }}</td>
                        <td class="px-3 py-2 text-center">
                            {% set type_code = item.get('Type', '') %}
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold
                                {% if type_code == 'L' %}bg-blue-100 text-blue-700
                                {% elif type_code == 'M' %}bg-purple-100 text-purple-700
                                {% elif type_code == 'S' %}bg-orange-100 text-orange-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ type_code or '?' }}
                            </span>
                        </td>
                        <td class="px-3 py-2">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 shrink-0">
                                    ✓
                                </span>
                                <select class="budget-select flex-1 border border-green-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 bg-white min-w-80"
                                        data-dc-id="{{ item.get('direct_cost_id', '') }}"
                                        data-cost-code="{{ item.get('Cost Code', '') }}"
                                        data-name="{{ item.get('Name', '') }}"
                                        data-vendor="{{ item.get('Vendor', '') }}"
                                        data-suggested=""
                                        data-score="100"
                                        data-original="{{ item.get('mapped_budget_code', '') }}"
                                        onchange="enableDirectEditButton(this)"
                                        aria-label="Select budget code">
                                    {% for bc in budget_options %}
                                    <option value="{{ bc.code }}" title="{{ bc.description }}" {% if bc.code == item.get('mapped_budget_code') %}selected{% endif %}>{{ bc.display }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <select class="side-select border border-green-300 rounded px-1 py-0.5 text-xs bg-white"
                                    data-mapping-id="{{ item.get('mapping_id', '') }}"
                                    data-dc-id="{{ item.get('direct_cost_id', '') }}"
                                    data-cost-code="{{ item.get('Cost Code', '') }}"
                                    data-name="{{ item.get('Name', '') }}"
                                    data-original-side="{{ item.get('side', 'BOTH') }}"
                                    onchange="updateMappingSide(this, 'direct_to_budget')">
                                <option value="BOTH" {% if item.get('side', 'BOTH') == 'BOTH' %}selected{% endif %}>Both</option>
                                <option value="EAST" {% if item.get('side') == 'EAST' %}selected{% endif %}>East</option>
                                <option value="WEST" {% if item.get('side') == 'WEST' %}selected{% endif %}>West</option>
                            </select>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <span class="text-xs px-1.5 py-0.5 rounded bg-green-100 text-green-700">mapped</span>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <div class="flex gap-1 justify-center">
                                <button onclick="saveDirectMapping(this)"
                                        class="save-btn px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed transition-colors hidden">
                                    Update
                                </button>
                                <button onclick="deleteDirectMapping('{{ item.get('Cost Code', '') }}', '{{ item.get('Name', '')|e }}')"
                                        class="delete-btn px-2 py-1 text-red-600 hover:text-red-800 text-xs hover:bg-red-50 rounded">
                                    Remove
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Load More Button for Direct→Budget -->
        {% if has_more_direct %}
        <div id="directLoadMoreContainer" class="flex justify-center items-center gap-4 py-4 border-t">
            <button onclick="loadMoreDirectItems()" id="loadMoreDirectBtn"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Load More
            </button>
            <span class="text-sm text-gray-500" id="directLoadedCount">
                Showing <span id="directLoadedNum">{{ unmapped_direct|length }}</span> of {{ total_unmapped_direct }} unmapped items
            </span>
        </div>
        {% endif %}

        <!-- Footer Info -->
        <div class="flex justify-between items-center text-sm text-gray-500">
            <span>{{ total_unmapped_direct }} unmapped, {{ mapped_direct|length }} mapped</span>
            <span>Total: {{ total_direct }} direct cost items</span>
        </div>

        {% if not unmapped_direct and not mapped_direct %}
        <div class="text-center py-12 text-gray-500">
            <p class="text-xl">No direct cost items found.</p>
        </div>
        {% elif not unmapped_direct %}
        <div class="text-center py-8 text-green-600 bg-green-50 rounded-lg">
            <svg class="w-16 h-16 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-lg font-medium">All direct cost items are mapped!</p>
        </div>
        {% endif %}
    </div>

    <!-- Score Breakdown Modal -->
    <div id="scoreModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Match Score Breakdown</h3>
                <button onclick="closeScoreModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="scoreModalContent" class="space-y-4">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    {% elif active_tab == 'allocation' %}
    <!-- Regional Allocations -->
    <div class="space-y-6">
        <!-- Add New Allocation -->
        <div class="bg-gray-50 rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">Add New Allocation</h3>
            <form action="/mappings/save" method="POST" class="flex gap-4 items-end" id="allocationForm">
                <input type="hidden" name="mapping_type" value="allocation">

                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Code</label>
                    <input type="text" name="code" class="w-full border rounded-lg px-3 py-2" required
                           placeholder="e.g., 1-010 or 1-010.L">
                </div>

                <div class="w-32">
                    <label class="block text-sm font-medium text-gray-700 mb-1">% West</label>
                    <div class="relative">
                        <input type="number" name="pct_west" id="pctWest" class="w-full border rounded-lg px-3 py-2 pr-8"
                               min="0" max="100" value="50" required onchange="updateEast()">
                        <span class="absolute right-3 top-2 text-gray-400">%</span>
                    </div>
                </div>

                <div class="w-32">
                    <label class="block text-sm font-medium text-gray-700 mb-1">% East</label>
                    <div class="relative">
                        <input type="number" name="pct_east" id="pctEast" class="w-full border rounded-lg px-3 py-2 pr-8"
                               min="0" max="100" value="50" required readonly>
                        <span class="absolute right-3 top-2 text-gray-400">%</span>
                    </div>
                </div>

                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Add Allocation
                </button>
            </form>
        </div>

        <!-- Existing Allocations -->
        <div class="border rounded-lg overflow-hidden">
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700">Code</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700">West</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700">East</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700">Visual</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700">Status</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700 w-24">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for a in allocations %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">{{ a.code }}</span>
                        </td>
                        <td class="px-4 py-3 text-center font-medium">{{ "%.0f"|format(a.pct_west * 100) }}%</td>
                        <td class="px-4 py-3 text-center font-medium">{{ "%.0f"|format(a.pct_east * 100) }}%</td>
                        <td class="px-4 py-3">
                            <div class="flex h-4 rounded-full overflow-hidden">
                                <div class="bg-blue-500" style="width: {{ a.pct_west * 100 }}%"></div>
                                <div class="bg-orange-500" style="width: {{ a.pct_east * 100 }}%"></div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if a.confirmed %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Confirmed
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Pending
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="deleteAllocation('{{ a.code }}')" class="text-red-600 hover:text-red-800 text-sm">
                                Remove
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not allocations %}
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            No custom allocations defined. Default is 50/50 split for all codes.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Success Toast -->
<div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
    <span id="toastMessage">Mapping saved!</span>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Filter table by search text
function filterTable(tableId, searchText) {
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll('tbody tr');
    const search = searchText.toLowerCase();

    rows.forEach(row => {
        const code = (row.dataset.code || '').toLowerCase();
        const desc = (row.dataset.desc || '').toLowerCase();
        const visible = code.includes(search) || desc.includes(search);
        row.style.display = visible ? '' : 'none';
    });
}

// Filter by mapping status
function filterByStatus(tableId, status) {
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll('tbody tr');

    rows.forEach(row => {
        const rowStatus = row.dataset.status;
        if (status === 'all') {
            row.style.display = '';
        } else {
            row.style.display = rowStatus === status ? '' : 'none';
        }
    });
}

// Enable save button when selection is made
function enableSaveButton(select) {
    const btn = select.closest('tr').querySelector('.save-btn');
    btn.disabled = !select.value;
}

// Enable edit button when mapped item is changed
function enableEditButton(select) {
    const row = select.closest('tr');
    const btn = row.querySelector('.save-btn');
    const original = select.dataset.original;
    const changed = select.value !== original;

    if (changed) {
        btn.classList.remove('hidden');
        btn.disabled = false;
    } else {
        btn.classList.add('hidden');
    }
}

// Toggle mapped direct items table
function toggleMappedDirect() {
    const table = document.getElementById('mappedDirectTable');
    const arrow = document.getElementById('mappedDirectArrow');

    if (table.classList.contains('hidden')) {
        table.classList.remove('hidden');
        arrow.classList.add('rotate-180');
    } else {
        table.classList.add('hidden');
        arrow.classList.remove('rotate-180');
    }
}

// Delete direct cost mapping
function deleteDirectMapping(costCode, name) {
    if (!confirm('Remove this mapping?')) return;

    const formData = new FormData();
    formData.append('mapping_type', 'direct_to_budget');
    formData.append('cost_code', costCode);
    formData.append('name', name);
    formData.append('action', 'delete');

    fetch('/mappings/save', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showToast('Mapping removed');
            location.reload();
        } else {
            showToast('Error removing mapping', true);
        }
    });
}

// Save mapping via AJAX
function saveMapping(btn, mappingType) {
    const row = btn.closest('tr');
    const select = row.querySelector('select');
    const budgetCode = select.dataset.budgetCode;
    const gmpDivision = select.value;

    if (!gmpDivision) return;

    btn.disabled = true;
    btn.textContent = 'Saving...';

    const formData = new FormData();
    formData.append('mapping_type', mappingType);
    formData.append('budget_code', budgetCode);
    formData.append('gmp_division', gmpDivision);

    fetch('/mappings/save', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            // Update row appearance
            row.classList.remove('hover:bg-blue-50');
            row.classList.add('bg-green-50', 'hover:bg-green-100');
            row.dataset.status = 'mapped';

            // Replace select with text
            const td = select.parentElement;
            td.innerHTML = `
                <span class="inline-flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    <span class="font-medium">${gmpDivision}</span>
                </span>
            `;

            // Update button
            btn.outerHTML = `<button onclick="deleteMapping('${budgetCode}', 'budget_to_gmp')" class="text-red-600 hover:text-red-800 text-sm">Remove</button>`;

            showToast('Mapping saved successfully!');
        } else {
            btn.disabled = false;
            btn.textContent = 'Save';
            showToast('Error saving mapping', true);
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.textContent = 'Save';
        showToast('Error saving mapping', true);
    });
}

// Save direct cost mapping with feedback data
function saveDirectMapping(btn) {
    const row = btn.closest('tr');
    const select = row.querySelector('.budget-select');
    const costCode = select.dataset.costCode;
    const name = select.dataset.name;
    const vendor = select.dataset.vendor || '';
    const suggestedBudget = select.dataset.suggested || '';
    const suggestionScore = select.dataset.score || '0';
    const budgetCode = select.value;

    if (!budgetCode) return;

    btn.disabled = true;
    btn.textContent = 'Saving...';

    const formData = new FormData();
    formData.append('mapping_type', 'direct_to_budget');
    formData.append('cost_code', costCode);
    formData.append('name', name);
    formData.append('vendor', vendor);
    formData.append('budget_code', budgetCode);
    formData.append('suggested_budget_code', suggestedBudget);
    formData.append('suggestion_score', suggestionScore);

    fetch('/mappings/save', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            row.classList.remove('bg-green-50', 'bg-yellow-50', 'hover:bg-blue-50');
            row.classList.add('bg-gray-100');

            const selectCell = select.closest('td');
            selectCell.innerHTML = `<span class="inline-flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                <span class="font-medium text-green-700">${budgetCode}</span>
            </span>`;

            btn.outerHTML = '<span class="text-green-600 text-sm font-medium">✓ Saved</span>';
            showToast('Mapping saved successfully!');

            // Update stats (decrement counters visually)
            updateStatsDisplay();
        } else {
            btn.disabled = false;
            btn.textContent = 'Save';
            showToast('Error saving mapping', true);
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.textContent = 'Save';
        showToast('Error saving mapping', true);
    });
}

// Quick accept - one-click accept for high-confidence suggestions
function quickAccept(btn) {
    const row = btn.closest('tr');
    const select = row.querySelector('.budget-select');
    const budgetCode = btn.dataset.budgetCode;
    const costCode = select.dataset.costCode;
    const name = select.dataset.name;
    const vendor = select.dataset.vendor || '';
    const suggestionScore = select.dataset.score || '0';

    if (!budgetCode) return;

    // Show loading state
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

    const formData = new FormData();
    formData.append('mapping_type', 'direct_to_budget');
    formData.append('cost_code', costCode);
    formData.append('name', name);
    formData.append('vendor', vendor);
    formData.append('budget_code', budgetCode);
    formData.append('suggested_budget_code', budgetCode);
    formData.append('suggestion_score', suggestionScore);

    fetch('/mappings/save', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            // Update row appearance
            row.classList.remove('bg-green-50', 'bg-yellow-50', 'hover:bg-blue-50');
            row.classList.add('bg-gray-100');
            row.dataset.status = 'mapped';

            // Update the budget code cell
            const selectCell = select.closest('td');
            selectCell.innerHTML = `<span class="inline-flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                <span class="font-medium text-green-700">${budgetCode}</span>
            </span>`;

            // Update status cell
            const statusCell = row.querySelector('td:nth-child(7)');
            if (statusCell) {
                statusCell.innerHTML = '<span class="text-xs px-1.5 py-0.5 rounded bg-green-100 text-green-700">mapped</span>';
            }

            // Replace button with checkmark
            btn.outerHTML = '<span class="text-green-600 text-sm font-medium flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>';

            showToast(`Accepted: ${budgetCode}`);
            updateStatsDisplay();
        } else {
            btn.disabled = false;
            btn.innerHTML = originalContent;
            showToast('Error saving mapping', true);
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalContent;
        showToast('Error saving mapping', true);
    });
}

// Filter direct cost table by search text
function filterDirectTable(searchText) {
    const rows = document.querySelectorAll('#directTableBody tr');
    const search = searchText.toLowerCase();

    rows.forEach(row => {
        const code = (row.dataset.code || '').toLowerCase();
        const name = (row.dataset.name || '').toLowerCase();
        const vendor = (row.dataset.vendor || '').toLowerCase();
        const visible = code.includes(search) || name.includes(search) || vendor.includes(search);
        row.style.display = visible ? '' : 'none';
    });
}

// Filter by confidence band
function filterByConfidence(band) {
    const rows = document.querySelectorAll('#directTableBody tr');

    rows.forEach(row => {
        const rowBand = row.dataset.band;
        if (band === 'all') {
            row.style.display = '';
        } else {
            row.style.display = rowBand === band ? '' : 'none';
        }
    });
}

// Filter direct cost table by mapping status
function filterDirectByStatus(status) {
    const rows = document.querySelectorAll('#directTableBody tr');

    rows.forEach(row => {
        const rowStatus = row.dataset.status;
        if (status === 'all') {
            row.style.display = '';
        } else {
            row.style.display = rowStatus === status ? '' : 'none';
        }
    });
}

// Enable edit button when mapped direct cost item is changed
function enableDirectEditButton(select) {
    const row = select.closest('tr');
    const btn = row.querySelector('.save-btn');
    const original = select.dataset.original;
    const changed = select.value !== original;

    if (changed) {
        btn.classList.remove('hidden');
        btn.disabled = false;
    } else {
        btn.classList.add('hidden');
    }
}

// Filter by cost type
function filterByType(type) {
    const rows = document.querySelectorAll('#directTableBody tr');

    rows.forEach(row => {
        const rowType = row.dataset.type;
        if (type === 'all') {
            row.style.display = '';
        } else {
            row.style.display = rowType === type ? '' : 'none';
        }
    });
}

// Side filter - navigates to URL with side parameter for server-side filtering
function applySideFilter(side) {
    const url = new URL(window.location.href);
    const tab = url.searchParams.get('tab') || 'budget_to_gmp';

    if (side) {
        url.searchParams.set('side', side);
    } else {
        url.searchParams.delete('side');
    }
    url.searchParams.set('tab', tab);

    window.location.href = url.toString();
}

// Update side for an existing mapping via API
async function updateMappingSide(selectElement, mappingType) {
    const newSide = selectElement.value;
    const originalSide = selectElement.dataset.originalSide;

    // Skip if no change
    if (newSide === originalSide) {
        return;
    }

    let mappingId;
    let endpoint;

    if (mappingType === 'budget_to_gmp') {
        // For budget mappings, we need to find the mapping by budget code
        const budgetCode = selectElement.dataset.budgetCode;
        // Use bulk update with filter
        endpoint = '/api/mappings/bulk-side';
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mapping_type: 'budget_to_gmp',
                    filter: { budget_code: budgetCode },
                    side: newSide
                })
            });

            if (!response.ok) {
                throw new Error('Failed to update side');
            }

            const result = await response.json();
            if (result.success) {
                selectElement.dataset.originalSide = newSide;
                showToast(`Side updated to ${newSide}`, 'success');
                // Update visual styling
                updateSideSelectStyle(selectElement, newSide);
            }
        } catch (error) {
            console.error('Error updating side:', error);
            selectElement.value = originalSide;
            showToast('Failed to update side', 'error');
        }
    } else if (mappingType === 'direct_to_budget') {
        // For direct mappings, use the mapping ID if available
        mappingId = selectElement.dataset.mappingId;
        if (mappingId) {
            endpoint = `/api/mappings/direct_to_budget/${mappingId}/side`;
            try {
                const response = await fetch(endpoint, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ side: newSide })
                });

                if (!response.ok) {
                    throw new Error('Failed to update side');
                }

                const result = await response.json();
                if (result.success) {
                    selectElement.dataset.originalSide = newSide;
                    showToast(`Side updated to ${newSide}`, 'success');
                    updateSideSelectStyle(selectElement, newSide);
                }
            } catch (error) {
                console.error('Error updating side:', error);
                selectElement.value = originalSide;
                showToast('Failed to update side', 'error');
            }
        }
    }
}

// Update visual styling of side select based on value
function updateSideSelectStyle(selectElement, side) {
    selectElement.classList.remove('border-blue-300', 'border-green-300', 'border-purple-300');
    if (side === 'EAST') {
        selectElement.classList.add('border-blue-300');
    } else if (side === 'WEST') {
        selectElement.classList.add('border-green-300');
    } else {
        selectElement.classList.add('border-purple-300');
    }
}

// Toggle select all checkbox
function toggleSelectAll(checkbox) {
    const rowCheckboxes = document.querySelectorAll('.row-select');
    rowCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

// Bulk accept high confidence suggestions
function bulkAcceptHighConfidence() {
    const btn = document.getElementById('bulkAcceptBtn');
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...';

    fetch('/api/mappings/bulk-accept', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            min_confidence: 85
        })
    })
    .then(response => response.json())
    .then(data => {
        showToast(`Accepted ${data.accepted} mappings, skipped ${data.skipped}`);
        // Reload to show updated state
        setTimeout(() => location.reload(), 1500);
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = 'Accept All High-Confidence';
        showToast('Error during bulk accept', true);
    });
}

// Show score breakdown modal
function showScoreBreakdown(dcId) {
    const modal = document.getElementById('scoreModal');
    const content = document.getElementById('scoreModalContent');

    content.innerHTML = '<div class="text-center py-4"><div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div><p class="mt-2 text-gray-500">Loading...</p></div>';
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    fetch(`/api/mappings/suggestions/${dcId}`)
        .then(response => response.json())
        .then(data => {
            if (data.suggestions && data.suggestions.length > 0) {
                const sugg = data.suggestions[0];
                const breakdown = sugg.breakdown || {};

                content.innerHTML = `
                    <div class="border-b pb-4">
                        <p class="text-sm text-gray-500">Top Match</p>
                        <p class="text-lg font-semibold">${sugg.budget_code}</p>
                        <p class="text-sm text-gray-600">${sugg.description}</p>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Overall Score</span>
                            <span class="text-2xl font-bold ${sugg.confidence_band === 'high' ? 'text-green-600' : sugg.confidence_band === 'medium' ? 'text-yellow-600' : 'text-red-600'}">
                                ${sugg.score}%
                            </span>
                        </div>

                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Code Match (40%)</span>
                                <span class="font-medium">${(breakdown.code_match * 100).toFixed(0)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${breakdown.code_match * 100}%"></div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Type Match (20%)</span>
                                <span class="font-medium">${(breakdown.type_match * 100).toFixed(0)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full" style="width: ${breakdown.type_match * 100}%"></div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Text Similarity (30%)</span>
                                <span class="font-medium">${(breakdown.text_sim * 100).toFixed(0)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: ${breakdown.text_sim * 100}%"></div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Historical Pattern (10%)</span>
                                <span class="font-medium">${(breakdown.historical * 100).toFixed(0)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-orange-600 h-2 rounded-full" style="width: ${breakdown.historical * 100}%"></div>
                            </div>
                        </div>
                    </div>

                    ${data.suggestions.length > 1 ? `
                    <div class="border-t pt-4 mt-4">
                        <p class="text-sm text-gray-500 mb-2">Other Matches</p>
                        ${data.suggestions.slice(1, 4).map(s => `
                            <div class="flex justify-between items-center py-1">
                                <span class="text-sm">${s.budget_code}</span>
                                <span class="text-sm font-medium">${s.score}%</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                `;
            } else {
                content.innerHTML = '<p class="text-center text-gray-500 py-4">No suggestions available</p>';
            }
        })
        .catch(err => {
            content.innerHTML = '<p class="text-center text-red-500 py-4">Error loading breakdown</p>';
        });
}

// Close score modal
function closeScoreModal() {
    const modal = document.getElementById('scoreModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Close modal on backdrop click
document.getElementById('scoreModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeScoreModal();
    }
});

// Update stats display after saving
function updateStatsDisplay() {
    // This would decrement the counters, but for simplicity we'll rely on page reload
    // In a production app, you'd update the DOM counters directly
}

// Delete mapping
function deleteMapping(code, type) {
    if (!confirm('Remove this mapping?')) return;

    const formData = new FormData();
    formData.append('mapping_type', type);
    formData.append('budget_code', code);
    formData.append('action', 'delete');

    fetch('/mappings/save', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        }
    });
}

// Delete allocation
function deleteAllocation(code) {
    if (!confirm('Remove this allocation?')) return;

    const formData = new FormData();
    formData.append('mapping_type', 'allocation');
    formData.append('code', code);
    formData.append('action', 'delete');

    fetch('/mappings/save', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        }
    });
}

// Accept all suggested mappings
function acceptAllSuggested() {
    const selects = document.querySelectorAll('.gmp-select');
    let count = 0;

    selects.forEach(select => {
        if (select.value && select.selectedIndex > 0) {
            const btn = select.closest('tr').querySelector('.save-btn');
            if (btn && !btn.disabled) {
                saveMapping(btn, 'budget_to_gmp');
                count++;
            }
        }
    });

    if (count === 0) {
        showToast('No suggestions to accept', true);
    }
}

// Update East percentage when West changes
function updateEast() {
    const west = parseInt(document.getElementById('pctWest').value) || 0;
    document.getElementById('pctEast').value = 100 - west;
}

// Convert percentages before form submit
document.getElementById('allocationForm')?.addEventListener('submit', function(e) {
    const westInput = document.querySelector('input[name="pct_west"]');
    const eastInput = document.querySelector('input[name="pct_east"]');
    westInput.value = parseFloat(westInput.value) / 100;
    eastInput.value = parseFloat(eastInput.value) / 100;
});

// Show toast notification
function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    toastMessage.textContent = message;
    toast.className = toast.className.replace('bg-green-600', isError ? 'bg-red-600' : 'bg-green-600');
    toast.className = toast.className.replace('bg-red-600', isError ? 'bg-red-600' : 'bg-green-600');

    toast.classList.remove('translate-y-20', 'opacity-0');

    setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
    }, 3000);
}

// ============================================================
// Searchable Budget Dropdown Component
// ============================================================

class SearchableDropdown {
    constructor(selectElement) {
        this.select = selectElement;
        this.options = Array.from(selectElement.options).map(opt => ({
            value: opt.value,
            text: opt.textContent,
            title: opt.title || '',
            selected: opt.selected,
            disabled: opt.disabled
        }));
        this.selectedValue = selectElement.value;
        this.isOpen = false;
        this.highlightedIndex = -1;
        this.filteredOptions = [];
        this.scrollHandler = null;
        this.resizeHandler = null;

        this.init();
    }

    init() {
        // Create wrapper
        this.wrapper = document.createElement('div');
        this.wrapper.className = 'searchable-dropdown';

        // Create search input
        this.input = document.createElement('input');
        this.input.type = 'text';
        this.input.className = 'searchable-dropdown-input';
        this.input.placeholder = '-- Search budget code --';
        this.input.setAttribute('autocomplete', 'off');
        this.input.setAttribute('aria-label', 'Search budget code');
        this.input.setAttribute('aria-haspopup', 'listbox');
        this.input.setAttribute('aria-expanded', 'false');

        // Set initial display value
        const selectedOpt = this.options.find(o => o.value === this.selectedValue);
        if (selectedOpt && selectedOpt.value) {
            this.input.value = selectedOpt.text;
        }

        // Create dropdown container - append to body for proper positioning
        this.dropdown = document.createElement('div');
        this.dropdown.className = 'searchable-dropdown-portal';
        this.dropdown.setAttribute('role', 'listbox');
        this.dropdown.style.display = 'none';

        // Create hidden input for form submission
        this.hiddenInput = document.createElement('input');
        this.hiddenInput.type = 'hidden';
        this.hiddenInput.name = this.select.name;
        this.hiddenInput.value = this.selectedValue;

        // Copy data attributes to wrapper
        Array.from(this.select.attributes).forEach(attr => {
            if (attr.name.startsWith('data-')) {
                this.wrapper.setAttribute(attr.name, attr.value);
            }
        });

        // Insert wrapper where select was
        this.select.parentNode.insertBefore(this.wrapper, this.select);
        this.wrapper.appendChild(this.input);
        this.wrapper.appendChild(this.hiddenInput);
        this.select.style.display = 'none';

        // Append dropdown to body (portal pattern)
        document.body.appendChild(this.dropdown);

        // Bind events
        this.bindEvents();
    }

    bindEvents() {
        // Input focus
        this.input.addEventListener('focus', () => {
            this.filterOptions('');
            this.open();
        });

        // Input click
        this.input.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!this.isOpen) {
                this.filterOptions(this.input.value);
                this.open();
            }
        });

        // Input typing
        this.input.addEventListener('input', () => {
            this.filterOptions(this.input.value);
            if (!this.isOpen) this.open();
        });

        // Keyboard navigation
        this.input.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (!this.isOpen) {
                        this.filterOptions('');
                        this.open();
                    }
                    this.highlightNext();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    this.highlightPrev();
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (this.highlightedIndex >= 0 && this.filteredOptions[this.highlightedIndex]) {
                        this.selectOption(this.filteredOptions[this.highlightedIndex]);
                    }
                    break;
                case 'Escape':
                    this.close();
                    this.input.blur();
                    break;
                case 'Tab':
                    this.close();
                    break;
            }
        });

        // Click outside to close
        document.addEventListener('mousedown', (e) => {
            if (this.isOpen && !this.wrapper.contains(e.target) && !this.dropdown.contains(e.target)) {
                this.close();
            }
        });

        // Prevent dropdown interactions from closing
        this.dropdown.addEventListener('mousedown', (e) => {
            e.preventDefault();
        });
    }

    filterOptions(query) {
        const q = query.toLowerCase().trim();

        if (!q) {
            this.filteredOptions = this.options.filter(o => !o.disabled && o.value).slice(0, 100);
        } else {
            this.filteredOptions = this.options.filter(o => {
                if (o.disabled || !o.value) return false;
                return o.text.toLowerCase().includes(q) || o.title.toLowerCase().includes(q);
            }).slice(0, 50);
        }

        this.highlightedIndex = this.filteredOptions.length > 0 ? 0 : -1;
        this.renderDropdown();
    }

    renderDropdown() {
        this.dropdown.innerHTML = '';

        if (this.filteredOptions.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'searchable-dropdown-empty';
            noResults.textContent = 'No matching budget codes';
            this.dropdown.appendChild(noResults);
            return;
        }

        this.filteredOptions.forEach((opt, idx) => {
            const item = document.createElement('div');
            item.className = 'searchable-dropdown-item' +
                (idx === this.highlightedIndex ? ' highlighted' : '') +
                (opt.value === this.selectedValue ? ' selected' : '');
            item.setAttribute('role', 'option');
            if (opt.title) item.setAttribute('title', opt.title);
            item.textContent = opt.text;

            item.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.selectOption(opt);
            });

            item.addEventListener('mouseenter', () => {
                this.highlightedIndex = idx;
                this.updateHighlight();
            });

            this.dropdown.appendChild(item);
        });
    }

    updateHighlight() {
        const items = this.dropdown.querySelectorAll('.searchable-dropdown-item');
        items.forEach((item, idx) => {
            item.classList.toggle('highlighted', idx === this.highlightedIndex);
        });

        // Scroll item into view within dropdown only
        if (this.highlightedIndex >= 0 && items[this.highlightedIndex]) {
            items[this.highlightedIndex].scrollIntoView({ block: 'nearest', behavior: 'auto' });
        }
    }

    highlightNext() {
        if (this.filteredOptions.length === 0) return;
        this.highlightedIndex = (this.highlightedIndex + 1) % this.filteredOptions.length;
        this.updateHighlight();
    }

    highlightPrev() {
        if (this.filteredOptions.length === 0) return;
        this.highlightedIndex = this.highlightedIndex <= 0
            ? this.filteredOptions.length - 1
            : this.highlightedIndex - 1;
        this.updateHighlight();
    }

    selectOption(opt) {
        this.selectedValue = opt.value;
        this.input.value = opt.text;
        this.hiddenInput.value = opt.value;
        this.select.value = opt.value;
        this.select.dispatchEvent(new Event('change', { bubbles: true }));
        this.close();
    }

    positionDropdown() {
        const rect = this.input.getBoundingClientRect();
        const dropdownHeight = 240; // Use fixed max height for stable positioning
        const spaceBelow = window.innerHeight - rect.bottom;
        const spaceAbove = rect.top;

        // Position below or above based on available space
        if (spaceBelow >= dropdownHeight || spaceBelow >= spaceAbove) {
            this.dropdown.style.top = (rect.bottom + window.scrollY + 2) + 'px';
        } else {
            this.dropdown.style.top = (rect.top + window.scrollY - dropdownHeight - 2) + 'px';
        }

        this.dropdown.style.left = (rect.left + window.scrollX) + 'px';
        // Use stable width - at least input width but allow for longer content
        const width = Math.max(rect.width, 280);
        this.dropdown.style.width = width + 'px';
    }

    // Debounce helper to prevent excessive repositioning
    debounce(fn, delay) {
        let timeoutId;
        return (...args) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    open() {
        if (this.isOpen) return;
        this.isOpen = true;
        this.dropdown.style.display = 'block';
        this.input.setAttribute('aria-expanded', 'true');
        this.positionDropdown();

        // Debounced reposition on scroll/resize to prevent jitter
        this.scrollHandler = this.debounce(() => this.positionDropdown(), 16);
        this.resizeHandler = this.debounce(() => this.positionDropdown(), 100);
        window.addEventListener('scroll', this.scrollHandler, true);
        window.addEventListener('resize', this.resizeHandler);
    }

    close() {
        if (!this.isOpen) return;
        this.isOpen = false;
        this.dropdown.style.display = 'none';
        this.input.setAttribute('aria-expanded', 'false');

        // Restore display value
        const selectedOpt = this.options.find(o => o.value === this.selectedValue);
        this.input.value = selectedOpt && selectedOpt.value ? selectedOpt.text : '';

        // Remove scroll/resize listeners
        if (this.scrollHandler) {
            window.removeEventListener('scroll', this.scrollHandler, true);
            this.scrollHandler = null;
        }
        if (this.resizeHandler) {
            window.removeEventListener('resize', this.resizeHandler);
            this.resizeHandler = null;
        }
    }

    destroy() {
        this.close();
        if (this.dropdown.parentNode) {
            this.dropdown.parentNode.removeChild(this.dropdown);
        }
    }
}

// Initialize searchable dropdowns
function initSearchableDropdowns() {
    const budgetSelects = document.querySelectorAll('.budget-select');
    budgetSelects.forEach(select => {
        // Only convert if it has many options (performance optimization)
        if (select.options.length > 20) {
            new SearchableDropdown(select);
        }
    });
}

// Initialize filters
document.addEventListener('DOMContentLoaded', function() {
    // Budget → GMP tab filter
    const filterSelect = document.getElementById('filterStatus');
    if (filterSelect) {
        filterByStatus('budgetTable', filterSelect.value);
    }

    // Direct Cost → Budget tab filter
    const filterDirectSelect = document.getElementById('filterDirectStatus');
    if (filterDirectSelect) {
        filterDirectByStatus(filterDirectSelect.value);
    }

    // Initialize searchable budget dropdowns
    initSearchableDropdowns();

    // Initialize keyboard shortcuts
    initKeyboardShortcuts();
});

// ============================================================
// Pagination - Load More Functionality
// ============================================================

const paginationState = {
    direct: {
        offset: {{ unmapped_direct|length }},
        total: {{ total_unmapped_direct }},
        loading: false,
        limit: 20
    },
    budget: {
        offset: {{ unmapped_budget|length }},
        total: {{ total_unmapped_budget }},
        loading: false,
        limit: 20
    }
};

// Get current filters for API calls
function getCurrentFilters() {
    const sideFilter = document.getElementById('filterDirectSide')?.value ||
                       document.getElementById('filterSide')?.value || '';
    return {
        side: sideFilter,
        status: 'unmapped'
    };
}

// Load more direct cost items
async function loadMoreDirectItems() {
    if (paginationState.direct.loading) return;
    if (paginationState.direct.offset >= paginationState.direct.total) return;

    const btn = document.getElementById('loadMoreDirectBtn');
    const loadedNum = document.getElementById('directLoadedNum');

    try {
        paginationState.direct.loading = true;
        btn.disabled = true;
        btn.innerHTML = `
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading...
        `;

        const filters = getCurrentFilters();
        const params = new URLSearchParams({
            status: 'unmapped',
            offset: paginationState.direct.offset,
            limit: paginationState.direct.limit,
            ...(filters.side && { side: filters.side })
        });

        const response = await fetch(`/api/mappings/direct/items?${params}`);
        const data = await response.json();

        if (data.items && data.items.length > 0) {
            appendDirectRows(data.items);
            paginationState.direct.offset += data.items.length;

            // Update loaded count
            if (loadedNum) {
                loadedNum.textContent = paginationState.direct.offset;
            }

            // Initialize searchable dropdowns for new rows
            initSearchableDropdowns();

            // Update keyboard navigation rows
            updateMappingRows();
        }

        // Hide button if no more items
        if (!data.pagination.hasMore) {
            document.getElementById('directLoadMoreContainer').style.display = 'none';
        }

    } catch (error) {
        console.error('Error loading more items:', error);
        showToast('Error loading more items', 'error');
    } finally {
        paginationState.direct.loading = false;
        btn.disabled = false;
        btn.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Load More
        `;
    }
}

// Append direct cost rows to the table
function appendDirectRows(items) {
    const tbody = document.getElementById('directTableBody');
    if (!tbody) return;

    // Find insertion point (before mapped items)
    const mappedRows = tbody.querySelectorAll('tr[data-status="mapped"]');
    const insertBefore = mappedRows.length > 0 ? mappedRows[0] : null;

    items.forEach(item => {
        const row = createDirectRow(item);
        if (insertBefore) {
            tbody.insertBefore(row, insertBefore);
        } else {
            tbody.appendChild(row);
        }
    });
}

// Create a direct cost table row from item data
function createDirectRow(item) {
    const tr = document.createElement('tr');
    const confBand = item.confidence_band || 'low';
    const topSugg = item.top_suggestion;

    tr.className = `hover:bg-blue-50 transition-colors ${confBand === 'high' ? 'bg-green-50' : confBand === 'medium' ? 'bg-yellow-50' : ''}`;
    tr.dataset.status = 'unmapped';
    tr.dataset.dcId = item.direct_cost_id || '';
    tr.dataset.code = item['Cost Code'] || '';
    tr.dataset.name = item.Name || '';
    tr.dataset.vendor = item.Vendor || '';
    tr.dataset.type = item.Type || '';
    tr.dataset.confidence = item.confidence || 0;
    tr.dataset.band = confBand;

    const vendorStr = (item.Vendor && typeof item.Vendor === 'string') ? item.Vendor : '';
    const nameStr = (item.Name && typeof item.Name === 'string') ? item.Name : '';
    const typeCode = item.Type || '';

    // Build suggestions options HTML
    let optionsHtml = '<option value="">-- Select Budget --</option>';
    if (topSugg) {
        const suggDesc = topSugg.description || '';
        const suggDescDisplay = suggDesc.length > 35 ? suggDesc.substring(0, 35) + '...' : suggDesc;
        optionsHtml += `<option value="${topSugg.budget_code || ''}" selected class="font-medium" title="${suggDesc}">★ ${topSugg.budget_code || ''} – ${suggDescDisplay || '(No description)'} (${Math.round(topSugg.score || 0)}%)</option>`;

        // Add alternative suggestions
        if (item.suggestions && item.suggestions.length > 1) {
            item.suggestions.slice(1).forEach(sugg => {
                const altDesc = sugg.description || '';
                const altDescDisplay = altDesc.length > 30 ? altDesc.substring(0, 30) + '...' : altDesc;
                optionsHtml += `<option value="${sugg.budget_code || ''}" title="${altDesc}">${sugg.budget_code || ''} – ${altDescDisplay || '(No desc)'} (${Math.round(sugg.score || 0)}%)</option>`;
            });
            optionsHtml += '<option disabled>──────────</option>';
        }
    }
    // Add all budget options (will be handled by searchable dropdown)
    {% for bc in budget_options %}
    optionsHtml += `<option value="{{ bc.code }}" title="{{ bc.description }}">{{ bc.display }}</option>`;
    {% endfor %}

    const confidenceBadgeClass = confBand === 'high' ? 'bg-green-100 text-green-800' :
                                  confBand === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-gray-100 text-gray-600';

    tr.innerHTML = `
        <td class="px-3 py-2 text-gray-600 max-w-32 truncate" title="${vendorStr}">${(vendorStr || 'N/A').substring(0, 20)}</td>
        <td class="px-3 py-2"><span class="font-mono text-xs bg-gray-100 px-1.5 py-0.5 rounded">${item['Cost Code'] || ''}</span></td>
        <td class="px-3 py-2 text-gray-600">
            <span class="truncate block max-w-48" title="${nameStr}">${(nameStr || 'N/A').substring(0, 35)}${nameStr.length > 35 ? '...' : ''}</span>
        </td>
        <td class="px-3 py-2 text-right font-mono text-sm">${item.Amount || ''}</td>
        <td class="px-3 py-2 text-center">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ${
                typeCode === 'L' ? 'bg-blue-100 text-blue-700' :
                typeCode === 'M' ? 'bg-purple-100 text-purple-700' :
                typeCode === 'S' ? 'bg-orange-100 text-orange-700' :
                'bg-gray-100 text-gray-700'
            }">${typeCode || '?'}</span>
        </td>
        <td class="px-3 py-2">
            <div class="flex items-center gap-2">
                ${topSugg ? `
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-bold shrink-0 ${confidenceBadgeClass}">${Math.round(item.confidence || 0)}%</span>
                ` : `
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 shrink-0">Manual</span>
                `}
                <select class="budget-select flex-1 border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 min-w-80 ${
                    confBand === 'high' ? 'border-green-300' :
                    confBand === 'medium' ? 'border-yellow-300' :
                    !topSugg ? 'border-red-300' : ''
                }"
                    data-dc-id="${item.direct_cost_id || ''}"
                    data-cost-code="${item['Cost Code'] || ''}"
                    data-name="${item.Name || ''}"
                    data-vendor="${item.Vendor || ''}"
                    data-suggested="${topSugg ? topSugg.budget_code : ''}"
                    data-score="${item.confidence || 0}"
                    data-original=""
                    onchange="enableSaveButton(this)"
                    aria-label="Select budget code">
                    ${optionsHtml}
                </select>
            </div>
        </td>
        <td class="px-3 py-2 text-center">
            <select class="side-select border rounded px-1 py-0.5 text-xs"
                    data-dc-id="${item.direct_cost_id || ''}"
                    data-cost-code="${item['Cost Code'] || ''}"
                    data-name="${item.Name || ''}">
                <option value="BOTH" selected>Both</option>
                <option value="EAST">East</option>
                <option value="WEST">West</option>
            </select>
        </td>
        <td class="px-3 py-2 text-center">
            <span class="text-xs px-1.5 py-0.5 rounded bg-red-100 text-red-700">unmapped</span>
        </td>
        <td class="px-3 py-2 text-center">
            <div class="flex gap-1 justify-center">
                ${confBand === 'high' && topSugg ? `
                <button onclick="quickAccept(this)"
                        class="quick-accept-btn px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors flex items-center gap-1"
                        title="Accept ${topSugg.budget_code} (${Math.round(item.confidence || 0)}%)"
                        data-budget-code="${topSugg.budget_code}">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Accept
                </button>
                ` : `
                <button onclick="saveDirectMapping(this)"
                        class="save-btn px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                        ${!topSugg ? 'disabled' : ''}>
                    Save
                </button>
                `}
            </div>
        </td>
    `;

    return tr;
}

// Load more budget items
async function loadMoreBudgetItems() {
    if (paginationState.budget.loading) return;
    if (paginationState.budget.offset >= paginationState.budget.total) return;

    const btn = document.getElementById('loadMoreBudgetBtn');
    const container = document.getElementById('budgetLoadMoreContainer');

    try {
        paginationState.budget.loading = true;
        btn.disabled = true;
        btn.innerHTML = `
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading...
        `;

        const sideFilter = document.getElementById('filterSide')?.value || '';
        const params = new URLSearchParams({
            status: 'unmapped',
            offset: paginationState.budget.offset,
            limit: paginationState.budget.limit,
            ...(sideFilter && { side: sideFilter })
        });

        const response = await fetch(`/api/mappings/budget/items?${params}`);
        const data = await response.json();

        if (data.items && data.items.length > 0) {
            appendBudgetRows(data.items);
            paginationState.budget.offset += data.items.length;

            // Update loaded count
            const countSpan = container.querySelector('#budgetLoadedCount');
            if (countSpan) {
                countSpan.textContent = `Showing ${paginationState.budget.offset} of ${paginationState.budget.total} unmapped items`;
            }
        }

        // Hide button if no more items
        if (!data.pagination.hasMore) {
            container.style.display = 'none';
        }

    } catch (error) {
        console.error('Error loading more budget items:', error);
        showToast('Error loading more items', 'error');
    } finally {
        paginationState.budget.loading = false;
        btn.disabled = false;
        btn.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Load More
        `;
    }
}

// Append budget rows to the table
function appendBudgetRows(items) {
    const table = document.getElementById('budgetTable');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    // Find insertion point (before mapped items)
    const mappedRows = tbody.querySelectorAll('tr[data-status="mapped"]');
    const insertBefore = mappedRows.length > 0 ? mappedRows[0] : null;

    items.forEach(item => {
        const row = createBudgetRow(item);
        if (insertBefore) {
            tbody.insertBefore(row, insertBefore);
        } else {
            tbody.appendChild(row);
        }
    });
}

// Create a budget table row from item data
function createBudgetRow(item) {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-blue-50 transition-colors';
    tr.dataset.status = 'unmapped';
    tr.dataset.code = item['Budget Code'] || '';
    tr.dataset.desc = item['Budget Code Description'] || '';

    const budgetCode = item['Budget Code'] || '';
    const desc = item['Budget Code Description'] || '';
    const descDisplay = desc.length > 50 ? desc.substring(0, 50) + '...' : desc;
    const costType = item['Cost Type'] || '';
    const suggestedGmp = item.suggested_gmp || '';
    const suggestionConf = item.suggestion_confidence || 0;

    // Build GMP options
    let optionsHtml = '<option value="">-- Select GMP Division --</option>';
    if (suggestedGmp) {
        optionsHtml += `<option value="${suggestedGmp}" class="bg-yellow-100" selected>★ ${suggestedGmp} (${Math.round(suggestionConf)}%)</option>`;
    }
    {% for gmp in gmp_options %}
    if ('{{ gmp }}' !== suggestedGmp) {
        optionsHtml += `<option value="{{ gmp }}">{{ gmp }}</option>`;
    }
    {% endfor %}

    tr.innerHTML = `
        <td class="px-4 py-3">
            <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">${budgetCode}</span>
        </td>
        <td class="px-4 py-3 text-gray-600 text-sm">
            <span title="${desc}">${descDisplay || 'N/A'}</span>
        </td>
        <td class="px-4 py-3 text-center">
            <span class="text-xs text-gray-500">${costType.substring(0, 10)}</span>
        </td>
        <td class="px-4 py-3">
            <select class="gmp-select w-full border rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-blue-500"
                    data-budget-code="${budgetCode}"
                    onchange="enableSaveButton(this)">
                ${optionsHtml}
            </select>
        </td>
        <td class="px-4 py-3 text-center">
            <select class="side-select border rounded px-1 py-0.5 text-xs"
                    data-budget-code="${budgetCode}">
                <option value="BOTH" selected>Both</option>
                <option value="EAST">East</option>
                <option value="WEST">West</option>
            </select>
        </td>
        <td class="px-4 py-3 text-center">
            <span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-700">unmapped</span>
        </td>
        <td class="px-4 py-3 text-center">
            <button onclick="saveMapping(this, 'budget_to_gmp')"
                    class="save-btn px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                    disabled>
                Save
            </button>
        </td>
    `;

    return tr;
}

// ============================================================
// Keyboard Shortcuts for Mapping Workflow
// ============================================================

let currentRowIndex = -1;
let mappingRows = [];

function initKeyboardShortcuts() {
    // Only enable on direct_to_budget tab
    const directTable = document.getElementById('directTableBody');
    if (!directTable) return;

    // Get all unmapped rows
    updateMappingRows();

    // Global keyboard handler
    document.addEventListener('keydown', handleKeyboardShortcut);

    // Add keyboard hint button
    addKeyboardHintButton();
}

function updateMappingRows() {
    const directTable = document.getElementById('directTableBody');
    if (!directTable) return;

    mappingRows = Array.from(directTable.querySelectorAll('tr[data-status="unmapped"]'))
        .filter(row => row.style.display !== 'none');
}

function handleKeyboardShortcut(e) {
    // Ignore if typing in input/textarea (except for specific shortcuts)
    const isTyping = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName);

    // Show help modal with ?
    if (e.key === '?' && !isTyping) {
        e.preventDefault();
        toggleKeyboardHelp();
        return;
    }

    // Close help modal with Escape
    if (e.key === 'Escape') {
        const helpModal = document.getElementById('keyboardHelpModal');
        if (helpModal && !helpModal.classList.contains('hidden')) {
            helpModal.classList.add('hidden');
            return;
        }
    }

    // Focus search with /
    if (e.key === '/' && !isTyping) {
        e.preventDefault();
        const searchInput = document.getElementById('searchDirect');
        if (searchInput) {
            searchInput.focus();
            searchInput.select();
        }
        return;
    }

    // Bulk accept with Ctrl+Shift+A
    if (e.key === 'A' && e.ctrlKey && e.shiftKey) {
        e.preventDefault();
        const bulkBtn = document.getElementById('bulkAcceptBtn');
        if (bulkBtn && !bulkBtn.disabled) {
            bulkAcceptHighConfidence();
        }
        return;
    }

    // Skip if typing (except navigation keys)
    if (isTyping && !['Escape', 'Enter', 'Tab'].includes(e.key)) return;

    // Update rows list (in case of filtering)
    updateMappingRows();
    if (mappingRows.length === 0) return;

    switch(e.key) {
        case 'j': // Next row (vim-style)
            if (!isTyping) {
                e.preventDefault();
                navigateToRow(currentRowIndex + 1);
            }
            break;

        case 'k': // Previous row (vim-style)
            if (!isTyping) {
                e.preventDefault();
                navigateToRow(currentRowIndex - 1);
            }
            break;

        case 'Tab':
            if (!e.shiftKey && !isTyping) {
                e.preventDefault();
                navigateToRow(currentRowIndex + 1);
            } else if (e.shiftKey && !isTyping) {
                e.preventDefault();
                navigateToRow(currentRowIndex - 1);
            }
            break;

        case 'a': // Accept current row
        case 'Enter':
            if (!isTyping && currentRowIndex >= 0) {
                e.preventDefault();
                acceptCurrentRow();
            }
            break;

        case 'g': // Go to first row
            if (!isTyping && e.shiftKey) {
                e.preventDefault();
                navigateToRow(mappingRows.length - 1); // G = last
            } else if (!isTyping) {
                e.preventDefault();
                navigateToRow(0); // g = first
            }
            break;

        case 'Escape':
            if (!isTyping) {
                clearRowSelection();
            }
            break;
    }
}

function navigateToRow(index) {
    if (mappingRows.length === 0) return;

    // Wrap around
    if (index < 0) index = mappingRows.length - 1;
    if (index >= mappingRows.length) index = 0;

    // Remove previous highlight
    if (currentRowIndex >= 0 && mappingRows[currentRowIndex]) {
        mappingRows[currentRowIndex].classList.remove('keyboard-selected');
    }

    currentRowIndex = index;
    const row = mappingRows[currentRowIndex];

    if (row) {
        // Add highlight
        row.classList.add('keyboard-selected');

        // Scroll into view
        row.scrollIntoView({ block: 'center', behavior: 'smooth' });

        // Focus the dropdown input if it exists
        const dropdownInput = row.querySelector('.searchable-dropdown-input');
        if (dropdownInput) {
            dropdownInput.focus();
        }

        // Show row info in toast
        const vendor = row.dataset.vendor || 'N/A';
        const code = row.dataset.code || '';
        showToast(`Row ${index + 1}/${mappingRows.length}: ${vendor.substring(0, 20)} - ${code}`, false);
    }
}

function acceptCurrentRow() {
    if (currentRowIndex < 0 || !mappingRows[currentRowIndex]) return;

    const row = mappingRows[currentRowIndex];

    // Try quick accept button first (for high confidence)
    const quickAcceptBtn = row.querySelector('.quick-accept-btn');
    if (quickAcceptBtn && !quickAcceptBtn.disabled) {
        quickAcceptBtn.click();
        // Move to next row after short delay
        setTimeout(() => {
            updateMappingRows();
            navigateToRow(currentRowIndex);
        }, 500);
        return;
    }

    // Otherwise try regular save button
    const saveBtn = row.querySelector('.save-btn');
    if (saveBtn && !saveBtn.disabled) {
        saveBtn.click();
        setTimeout(() => {
            updateMappingRows();
            navigateToRow(currentRowIndex);
        }, 500);
        return;
    }

    showToast('No suggestion to accept for this row', true);
}

function clearRowSelection() {
    if (currentRowIndex >= 0 && mappingRows[currentRowIndex]) {
        mappingRows[currentRowIndex].classList.remove('keyboard-selected');
    }
    currentRowIndex = -1;
    document.activeElement.blur();
}

function addKeyboardHintButton() {
    const filterSection = document.querySelector('#searchDirect')?.closest('.flex');
    if (!filterSection) return;

    const hintBtn = document.createElement('button');
    hintBtn.type = 'button';
    hintBtn.className = 'px-3 py-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-1';
    hintBtn.title = 'Keyboard shortcuts (?)';
    hintBtn.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"></path>
        </svg>
        <kbd class="hidden sm:inline px-1.5 py-0.5 text-xs font-mono bg-gray-200 rounded">?</kbd>
    `;
    hintBtn.onclick = toggleKeyboardHelp;
    filterSection.appendChild(hintBtn);

    // Create help modal
    createKeyboardHelpModal();
}

function createKeyboardHelpModal() {
    const modal = document.createElement('div');
    modal.id = 'keyboardHelpModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
    modal.onclick = (e) => { if (e.target === modal) modal.classList.add('hidden'); };

    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Keyboard Shortcuts</h3>
                <button onclick="document.getElementById('keyboardHelpModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Navigation</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><kbd class="kbd">j</kbd> or <kbd class="kbd">Tab</kbd></div>
                        <div class="text-gray-600">Next unmapped row</div>
                        <div><kbd class="kbd">k</kbd> or <kbd class="kbd">Shift+Tab</kbd></div>
                        <div class="text-gray-600">Previous unmapped row</div>
                        <div><kbd class="kbd">g</kbd></div>
                        <div class="text-gray-600">First row</div>
                        <div><kbd class="kbd">G</kbd></div>
                        <div class="text-gray-600">Last row</div>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Actions</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><kbd class="kbd">a</kbd> or <kbd class="kbd">Enter</kbd></div>
                        <div class="text-gray-600">Accept suggestion</div>
                        <div><kbd class="kbd">Ctrl+Shift+A</kbd></div>
                        <div class="text-gray-600">Bulk accept all high-confidence</div>
                        <div><kbd class="kbd">Esc</kbd></div>
                        <div class="text-gray-600">Clear selection / Close</div>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Search</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><kbd class="kbd">/</kbd></div>
                        <div class="text-gray-600">Focus search box</div>
                        <div><kbd class="kbd">?</kbd></div>
                        <div class="text-gray-600">Show this help</div>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">In Dropdown</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><kbd class="kbd">↑</kbd> <kbd class="kbd">↓</kbd></div>
                        <div class="text-gray-600">Navigate options</div>
                        <div><kbd class="kbd">Enter</kbd></div>
                        <div class="text-gray-600">Select option</div>
                        <div><kbd class="kbd">Esc</kbd></div>
                        <div class="text-gray-600">Close dropdown</div>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t text-xs text-gray-500 text-center">
                Press <kbd class="kbd">?</kbd> anytime to toggle this help
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

function toggleKeyboardHelp() {
    const modal = document.getElementById('keyboardHelpModal');
    if (modal) {
        modal.classList.toggle('hidden');
        if (!modal.classList.contains('hidden')) {
            modal.classList.add('flex');
        } else {
            modal.classList.remove('flex');
        }
    }
}
</script>

<style>
.tab-btn {
    @apply px-4 py-2 font-medium rounded-t-lg transition-colors;
}
.tab-btn:not(.active) {
    @apply text-gray-600 hover:bg-gray-100;
}
.tab-btn.active {
    @apply bg-blue-600 text-white;
}

/* Searchable Dropdown Styles */
.searchable-dropdown {
    flex: 1;
    min-width: 0;
}

.searchable-dropdown-input {
    width: 100%;
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 0.25rem;
    background: white;
    box-sizing: border-box;
    /* Stable dimensions */
    height: 34px;
    line-height: 1.25;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.searchable-dropdown-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
}

.searchable-dropdown-input::placeholder {
    color: #9ca3af;
}

/* Portal dropdown - fixed position relative to viewport */
.searchable-dropdown-portal {
    position: absolute;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    max-height: 240px;
    min-width: 280px;
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 99999;
    /* Prevent layout shifts */
    contain: layout style;
    will-change: transform;
    /* Stable scrollbar */
    scrollbar-gutter: stable;
}

.searchable-dropdown-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: white;
    /* Stable height */
    min-height: 36px;
    line-height: 20px;
    box-sizing: border-box;
}

.searchable-dropdown-item:hover,
.searchable-dropdown-item.highlighted {
    background-color: #dbeafe;
}

.searchable-dropdown-item.selected {
    font-weight: 600;
    color: #1d4ed8;
    background-color: #eff6ff;
}

.searchable-dropdown-item.selected.highlighted {
    background-color: #dbeafe;
}

.searchable-dropdown-empty {
    padding: 12px;
    color: #6b7280;
    font-size: 0.875rem;
    text-align: center;
    min-height: 44px;
}

/* Keyboard Navigation Styles */
.keyboard-selected {
    outline: 2px solid #3b82f6 !important;
    outline-offset: -2px;
    background-color: #eff6ff !important;
}

.keyboard-selected td {
    background-color: inherit;
}

/* Keyboard key styling */
.kbd {
    display: inline-block;
    padding: 2px 6px;
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
    font-size: 0.75rem;
    font-weight: 500;
    line-height: 1.25;
    color: #374151;
    background-color: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    box-shadow: inset 0 -1px 0 #d1d5db;
}
</style>
{% endblock %}
