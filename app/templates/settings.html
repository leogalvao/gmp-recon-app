{% extends "base.html" %}

{% block title %}Settings - GMP Reconciliation{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-6">
    <!-- Page Header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Settings</h1>
        <p class="text-gray-600 mt-1">Configure reconciliation parameters and preferences</p>
    </div>
    
    <!-- Settings Form -->
    <form action="/settings" method="POST" class="space-y-6">
        <!-- Date Settings -->
        <div class="card">
            <h2 class="text-lg font-semibold mb-4">Date Configuration</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="form-label">As-Of Date</label>
                    <p class="text-sm text-gray-500 mb-2">
                        Cutoff date for actuals and commitments. Leave as "Auto" to use the maximum transaction date.
                    </p>
                    <div class="flex items-center space-x-4">
                        <select name="as_of_date_type" id="as_of_date_type" class="form-input w-40" onchange="toggleDateInput()">
                            <option value="auto" {% if not settings or not settings.as_of_date %}selected{% endif %}>Auto (Max Date)</option>
                            <option value="custom" {% if settings and settings.as_of_date %}selected{% endif %}>Custom Date</option>
                        </select>
                        <input type="date" 
                               name="as_of_date" 
                               id="as_of_date_input"
                               class="form-input flex-1"
                               value="{{ settings.as_of_date.strftime('%Y-%m-%d') if settings and settings.as_of_date else '' }}"
                               {% if not settings or not settings.as_of_date %}disabled{% endif %}>
                    </div>
                    {% if max_transaction_date %}
                    <p class="text-sm text-gray-500 mt-2">
                        <svg class="w-4 h-4 inline text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Current max transaction date in data: <strong>{{ max_transaction_date }}</strong>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Forecast Settings -->
        <div class="card">
            <h2 class="text-lg font-semibold mb-4">Forecast Configuration</h2>
            
            <div class="space-y-6">
                <div>
                    <label class="form-label">Forecast Basis</label>
                    <p class="text-sm text-gray-500 mb-2">
                        Determines what data is used to compute the Estimate at Completion (EAC).
                    </p>
                    <div class="space-y-2">
                        <label class="flex items-start space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" 
                                   name="forecast_basis" 
                                   value="actuals_only" 
                                   class="mt-1"
                                   {% if settings and settings.forecast_basis == 'actuals_only' %}checked{% endif %}>
                            <div>
                                <div class="font-medium">Actuals Only</div>
                                <div class="text-sm text-gray-500">
                                    EAC = Actuals + ML Predicted Remaining<br>
                                    <span class="text-xs">Uses only incurred costs and ML predictions</span>
                                </div>
                            </div>
                        </label>
                        <label class="flex items-start space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" 
                                   name="forecast_basis" 
                                   value="actuals_plus_commitments" 
                                   class="mt-1"
                                   {% if not settings or settings.forecast_basis == 'actuals_plus_commitments' %}checked{% endif %}>
                            <div>
                                <div class="font-medium">Actuals + Commitments</div>
                                <div class="text-sm text-gray-500">
                                    EAC considers both ML predictions and outstanding commitments<br>
                                    <span class="text-xs">Recommended for most accurate forecasting</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div id="eac_mode_section" class="{% if settings and settings.forecast_basis == 'actuals_only' %}hidden{% endif %}">
                    <label class="form-label">EAC Mode (when using commitments)</label>
                    <p class="text-sm text-gray-500 mb-2">
                        How to combine ML predictions with commitment-based estimates.
                    </p>
                    <select name="eac_mode" class="form-input">
                        <option value="max" {% if not settings or settings.eac_mode_when_commitments == 'max' %}selected{% endif %}>
                            Maximum (Conservative) — Use higher of ML or Commitments
                        </option>
                        <option value="model" {% if settings and settings.eac_mode_when_commitments == 'model' %}selected{% endif %}>
                            Model Only — Trust ML predictions
                        </option>
                        <option value="commitments" {% if settings and settings.eac_mode_when_commitments == 'commitments' %}selected{% endif %}>
                            Commitments Only — Use committed amounts
                        </option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- GMP Scope Settings -->
        <div class="card">
            <h2 class="text-lg font-semibold mb-4">GMP Scope Configuration</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="form-label">Scope Notes</label>
                    <p class="text-sm text-gray-500 mb-2">
                        Document what's included in the GMP (contingency, allowances, owner-held items, alternates, etc.)
                    </p>
                    <textarea name="gmp_scope_notes" 
                              rows="4" 
                              class="form-input"
                              placeholder="e.g., GMP includes 3% contingency, excludes owner-held allowances...">{{ settings.gmp_scope_notes if settings and settings.gmp_scope_notes else '' }}</textarea>
                </div>
                
                <div>
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" 
                               name="gmp_scope_confirmed" 
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                               {% if settings and settings.gmp_scope_confirmed %}checked{% endif %}>
                        <span>
                            <span class="font-medium">GMP Scope Confirmed</span>
                            <span class="text-sm text-gray-500 block">
                                Check this to remove "Scope Unknown" badges from the GMP page
                            </span>
                        </span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Integration Settings (Breakdown & Schedule) -->
        <div class="card">
            <h2 class="text-lg font-semibold mb-4">Data Integration</h2>
            <p class="text-sm text-gray-500 mb-4">
                Configure East/West allocation sources and schedule-based forecasting.
            </p>

            <div class="space-y-6">
                <!-- Breakdown Integration -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">Breakdown Allocations</h3>
                            <p class="text-sm text-gray-500 mt-1">
                                Use owner's East/West funding breakdown (breakdown.csv) for allocation splits
                            </p>
                            <div id="breakdown-status" class="text-sm text-gray-500 mt-2">
                                Loading status...
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer ml-4">
                            <input type="checkbox"
                                   name="use_breakdown_allocations"
                                   id="use_breakdown_allocations"
                                   class="sr-only peer"
                                   {% if settings and settings.use_breakdown_allocations %}checked{% endif %}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <button type="button" onclick="importBreakdown()" class="btn btn-secondary text-sm py-1 px-3">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            Import breakdown.csv
                        </button>
                    </div>
                </div>

                <!-- Schedule Integration -->
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">Schedule-Based Forecasting</h3>
                            <p class="text-sm text-gray-500 mt-1">
                                Use project schedule progress (schedule.csv) for EAC calculation
                            </p>
                            <div id="schedule-status" class="text-sm text-gray-500 mt-2">
                                Loading status...
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer ml-4">
                            <input type="checkbox"
                                   name="use_schedule_forecast"
                                   id="use_schedule_forecast"
                                   class="sr-only peer"
                                   {% if settings and settings.use_schedule_forecast %}checked{% endif %}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <button type="button" onclick="importSchedule()" class="btn btn-secondary text-sm py-1 px-3">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            Import schedule.csv
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Last Run Info -->
        {% if last_run %}
        <div class="card">
            <h2 class="text-lg font-semibold mb-4">Last Run Information</h2>
            
            <dl class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <dt class="text-gray-500">Run Type</dt>
                    <dd class="font-medium capitalize">{{ last_run.run_type }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Status</dt>
                    <dd>
                        {% if last_run.status == 'completed' %}
                        <span class="badge badge-green">Completed</span>
                        {% elif last_run.status == 'running' %}
                        <span class="badge badge-blue">Running</span>
                        {% else %}
                        <span class="badge badge-red">Failed</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-gray-500">Started</dt>
                    <dd class="font-medium">{{ last_run.started_at.strftime('%Y-%m-%d %H:%M:%S') if last_run.started_at else '—' }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Finished</dt>
                    <dd class="font-medium">{{ last_run.finished_at.strftime('%Y-%m-%d %H:%M:%S') if last_run.finished_at else '—' }}</dd>
                </div>
                {% if last_run.notes %}
                <div class="col-span-2">
                    <dt class="text-gray-500">Notes</dt>
                    <dd class="font-mono text-xs bg-gray-50 p-2 rounded mt-1 overflow-x-auto">{{ last_run.notes }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>
        {% endif %}
        
        <!-- Actions -->
        <div class="flex justify-between items-center pt-4">
            <form action="/recompute" method="POST" class="inline">
                <button type="submit" class="btn btn-secondary">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Force Recompute & Retrain
                </button>
            </form>
            
            <button type="submit" class="btn btn-primary">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Save Settings
            </button>
        </div>
    </form>
    
    <!-- Duplicate Detection Settings -->
    <div class="card">
        <h2 class="text-lg font-semibold mb-4">Duplicate Detection Settings</h2>
        <p class="text-sm text-gray-500 mb-4">These settings are currently fixed but documented here for reference.</p>
        
        <dl class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <dt class="text-gray-500">Fuzzy Match Threshold</dt>
                <dd class="font-medium">90%</dd>
            </div>
            <div>
                <dt class="text-gray-500">Amount Tolerance</dt>
                <dd class="font-medium">±1%</dd>
            </div>
            <div>
                <dt class="text-gray-500">Date Window</dt>
                <dd class="font-medium">±7 days</dd>
            </div>
            <div>
                <dt class="text-gray-500">Auto-Collapse Threshold</dt>
                <dd class="font-medium">98%</dd>
            </div>
            <div>
                <dt class="text-gray-500">Reversal Detection Window</dt>
                <dd class="font-medium">14 days</dd>
            </div>
        </dl>
    </div>
    
    <!-- Background Jobs -->
    <div class="card">
        <h2 class="text-lg font-semibold mb-4">Background Jobs</h2>
        
        <dl class="space-y-3 text-sm">
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <div>
                    <div class="font-medium">Nightly Model Retrain</div>
                    <div class="text-gray-500">Retrains ML forecasting models</div>
                </div>
                <div class="text-right">
                    <div class="font-medium">02:00 AM</div>
                    <div class="text-gray-500">Daily</div>
                </div>
            </div>
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <div>
                    <div class="font-medium">File Change Detection</div>
                    <div class="text-gray-500">Checks for updated input files</div>
                </div>
                <div class="text-right">
                    <div class="font-medium">Every 5 min</div>
                    <div class="text-gray-500">Continuous</div>
                </div>
            </div>
        </dl>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function toggleDateInput() {
    const type = document.getElementById('as_of_date_type').value;
    const input = document.getElementById('as_of_date_input');
    
    if (type === 'auto') {
        input.disabled = true;
        input.value = '';
    } else {
        input.disabled = false;
    }
}

// Toggle EAC mode visibility based on forecast basis
document.querySelectorAll('input[name="forecast_basis"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const eacSection = document.getElementById('eac_mode_section');
        if (this.value === 'actuals_plus_commitments') {
            eacSection.classList.remove('hidden');
        } else {
            eacSection.classList.add('hidden');
        }
    });
});

// Load integration status on page load
async function loadIntegrationStatus() {
    try {
        const response = await fetch('/api/settings/integration');
        const data = await response.json();

        // Update breakdown status
        const breakdownStatus = document.getElementById('breakdown-status');
        if (data.breakdown.total > 0) {
            breakdownStatus.innerHTML = `
                <span class="text-green-600 font-medium">${data.breakdown.matched} matched</span>
                / ${data.breakdown.total} items
                ${data.breakdown.unmatched > 0 ? `<span class="text-amber-600">(${data.breakdown.unmatched} unmatched)</span>` : ''}
            `;
        } else {
            breakdownStatus.innerHTML = '<span class="text-gray-400">No breakdown data imported</span>';
        }

        // Update schedule status
        const scheduleStatus = document.getElementById('schedule-status');
        if (data.schedule.total > 0) {
            scheduleStatus.innerHTML = `
                <span class="text-green-600 font-medium">${data.schedule.mapped} mapped</span>
                / ${data.schedule.total} activities
                ${data.schedule.unmapped > 0 ? `<span class="text-amber-600">(${data.schedule.unmapped} unmapped)</span>` : ''}
            `;
        } else {
            scheduleStatus.innerHTML = '<span class="text-gray-400">No schedule data imported</span>';
        }

        // Sync toggle states
        document.getElementById('use_breakdown_allocations').checked = data.use_breakdown_allocations;
        document.getElementById('use_schedule_forecast').checked = data.use_schedule_forecast;
    } catch (error) {
        console.error('Error loading integration status:', error);
    }
}

// Import breakdown data
async function importBreakdown() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Importing...';

    try {
        const response = await fetch('/api/breakdown/import', { method: 'POST' });
        const data = await response.json();

        if (data.error) {
            alert('Import Error: ' + data.error);
        } else {
            alert(`Imported ${data.imported} items. ${data.matched} matched to GMP, ${data.unmatched} unmatched.`);
            loadIntegrationStatus();
        }
    } catch (error) {
        alert('Error importing breakdown: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Import schedule data
async function importSchedule() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Importing...';

    try {
        const response = await fetch('/api/schedule/import', { method: 'POST' });
        const data = await response.json();

        if (data.error) {
            alert('Import Error: ' + data.error);
        } else {
            alert(`Imported ${data.imported} activities. ${data.matched} matched to GMP, ${data.unmatched} unmatched.`);
            loadIntegrationStatus();
        }
    } catch (error) {
        alert('Error importing schedule: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Save integration toggle changes
document.getElementById('use_breakdown_allocations')?.addEventListener('change', async function() {
    const formData = new FormData();
    formData.append('use_breakdown_allocations', this.checked);
    await fetch('/api/settings/breakdown', { method: 'POST', body: formData });
});

document.getElementById('use_schedule_forecast')?.addEventListener('change', async function() {
    const formData = new FormData();
    formData.append('use_schedule_forecast', this.checked);
    await fetch('/api/settings/schedule', { method: 'POST', body: formData });
});

// Load status on page load
document.addEventListener('DOMContentLoaded', loadIntegrationStatus);
</script>
{% endblock %}
