<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}GMP Reconciliation{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.tailwindcss.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <style>
        .badge {
            @apply px-2 py-1 text-xs font-semibold rounded-full;
        }
        .badge-green { @apply bg-green-100 text-green-800; }
        .badge-red { @apply bg-red-100 text-red-800; }
        .badge-yellow { @apply bg-yellow-100 text-yellow-800; }
        .badge-blue { @apply bg-blue-100 text-blue-800; }
        .badge-gray { @apply bg-gray-100 text-gray-800; }
        
        .card {
            @apply bg-white rounded-lg shadow-md p-6;
        }
        
        .btn {
            @apply px-4 py-2 rounded-md font-medium transition-colors;
        }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
        .btn-secondary { @apply bg-gray-200 text-gray-800 hover:bg-gray-300; }
        .btn-success { @apply bg-green-600 text-white hover:bg-green-700; }
        .btn-danger { @apply bg-red-600 text-white hover:bg-red-700; }
        
        .surplus { color: #16a34a; }
        .overrun { color: #dc2626; }
        
        .table-container {
            @apply overflow-x-auto;
        }
        
        table.dataTable thead th {
            @apply bg-gray-50 text-gray-700 font-semibold text-sm uppercase tracking-wider;
        }
        
        table.dataTable tbody td {
            @apply px-4 py-3 text-sm text-gray-900;
        }
        
        table.dataTable tbody tr:hover {
            @apply bg-blue-50;
        }
        
        .nav-link {
            @apply px-4 py-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors;
        }
        .nav-link.active {
            @apply text-blue-600 bg-blue-50 font-medium;
        }
        
        .tab-btn {
            @apply px-4 py-2 text-gray-600 border-b-2 border-transparent hover:text-blue-600;
        }
        .tab-btn.active {
            @apply text-blue-600 border-blue-600 font-medium;
        }
        
        .form-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500;
        }
        
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        
        .alert {
            @apply p-4 rounded-md mb-4;
        }
        .alert-warning { @apply bg-yellow-50 border border-yellow-200 text-yellow-800; }
        .alert-error { @apply bg-red-50 border border-red-200 text-red-800; }
        .alert-info { @apply bg-blue-50 border border-blue-200 text-blue-800; }
        .alert-success { @apply bg-green-50 border border-green-200 text-green-800; }

        /* CSS Tokens for consistent styling */
        :root {
            --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', ui-monospace, monospace;
        }

        /* Tabular numbers for financial data */
        .tabular-nums {
            font-variant-numeric: tabular-nums;
        }

        /* Custom scrollbar for sidebars */
        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background-color: #D1D5DB;
            border-radius: 3px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background-color: #9CA3AF;
        }

        /* Smooth scrolling for main content */
        html {
            scroll-behavior: smooth;
        }

        /* Focus outline styling */
        *:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Loading spinner utility */
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Global Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            pointer-events: auto;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.hiding {
            opacity: 0;
            transform: translateX(120%);
        }

        .toast-success {
            background: #22C55E;
            color: white;
        }

        .toast-error {
            background: #EF4444;
            color: white;
        }

        .toast-warning {
            background: #FACC15;
            color: #422006;
        }

        .toast-info {
            background: #3B82F6;
            color: white;
        }

        .toast-icon {
            flex-shrink: 0;
            width: 1.25rem;
            height: 1.25rem;
        }

        .toast-message {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .toast-close {
            flex-shrink: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            opacity: 0.7;
            padding: 0.25rem;
            color: inherit;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* Inline Status Card */
        .status-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid;
            margin-bottom: 1rem;
        }

        .status-card-pending {
            background: #FEF3C7;
            border-color: #F59E0B;
            color: #92400E;
        }

        .status-card-success {
            background: #D1FAE5;
            border-color: #10B981;
            color: #065F46;
        }

        .status-card-error {
            background: #FEE2E2;
            border-color: #EF4444;
            color: #991B1B;
        }

        /* Collapsible error log */
        .error-log-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .error-log-container.expanded {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Button loading state */
        .btn-loading {
            position: relative;
            pointer-events: none;
        }

        .btn-loading .btn-text {
            visibility: hidden;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 1rem;
            height: 1rem;
            top: 50%;
            left: 50%;
            margin-left: -0.5rem;
            margin-top: -0.5rem;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        /* Skip to content link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #3B82F6;
            color: white;
            padding: 0.5rem 1rem;
            z-index: 100;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Keyboard shortcut hints */
        .kbd {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            font-size: 0.75rem;
            font-family: ui-monospace, monospace;
            background: #F3F4F6;
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
            box-shadow: 0 1px 0 #D1D5DB;
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- ARIA Live Region for screen reader announcements -->
    <div id="aria-live-region" class="sr-only" aria-live="polite" aria-atomic="true" style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;"></div>

    <!-- Global Toast Container -->
    <div id="toast-container" class="toast-container" role="status" aria-live="polite" aria-label="Notifications"></div>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50" role="navigation" aria-label="Main navigation">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-4">
                    <a href="/dashboard" class="flex items-center">
                        <span class="text-lg font-medium text-gray-700">GMP Reconciliation</span>
                    </a>
                    <!-- Project Selector -->
                    <div class="relative" id="project-selector-container">
                        <button type="button" id="project-selector-btn"
                                class="flex items-center space-x-2 px-3 py-1.5 text-sm bg-indigo-50 text-indigo-700 rounded-lg border border-indigo-200 hover:bg-indigo-100 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            <span id="current-project-name">Select Project</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="project-dropdown" class="hidden absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                            <div class="p-2">
                                <div id="project-list" class="max-h-64 overflow-y-auto">
                                    <div class="text-sm text-gray-500 p-2">Loading projects...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <a href="/dashboard" class="nav-link {% if active_page == 'dashboard' %}active{% endif %}">
                        <span class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                            </svg>
                            <span>Dashboard</span>
                        </span>
                    </a>
                    <a href="/gmp" class="nav-link {% if active_page == 'gmp' %}active{% endif %}">
                        <span class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7"></path>
                            </svg>
                            <span>GMP</span>
                        </span>
                    </a>
                    <a href="/mappings" class="nav-link {% if active_page == 'mappings' %}active{% endif %}">
                        <span class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                            <span>Mappings</span>
                        </span>
                    </a>
                    <a href="/duplicates" class="nav-link {% if active_page == 'duplicates' %}active{% endif %}">
                        <span class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            <span>Duplicates</span>
                        </span>
                    </a>
                    <a href="/data-health" class="nav-link {% if active_page == 'data-health' %}active{% endif %}">
                        <span class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Data Health</span>
                        </span>
                    </a>
                    <a href="/forecast" class="nav-link {% if active_page == 'forecast' %}active{% endif %}">
                        <span class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                            </svg>
                            <span>Forecast</span>
                        </span>
                    </a>
                    <a href="/schedule" class="nav-link {% if active_page == 'schedule' %}active{% endif %}">
                        <span class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span>Schedule</span>
                        </span>
                    </a>
                    <a href="/settings" class="nav-link {% if active_page == 'settings' %}active{% endif %}">
                        <span class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>Settings</span>
                        </span>
                    </a>
                    <div class="border-l border-gray-200 h-6 mx-2"></div>
                    <a href="/logout" class="nav-link text-gray-500 hover:text-red-600" title="Sign out">
                        <span class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            <span>Logout</span>
                        </span>
                    </a>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" role="main">
        {% block content %}{% endblock %}
    </main>
    
    <!-- CSRF Protection Scripts -->
    <script>
        // Get CSRF token from cookie
        function getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (const cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrf_token') {
                    return decodeURIComponent(value);
                }
            }
            return null;
        }

        // CSRF-protected fetch wrapper
        async function secureFetch(url, options = {}) {
            const csrfToken = getCsrfToken();
            const method = (options.method || 'GET').toUpperCase();

            // Add CSRF header for state-changing requests
            if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
                options.headers = {
                    ...options.headers,
                    'X-CSRF-Token': csrfToken
                };
            }

            return fetch(url, options);
        }

        // Override jQuery ajax to include CSRF token
        if (typeof $ !== 'undefined' && $.ajaxSetup) {
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!(/^(GET|HEAD|OPTIONS)$/.test(settings.type))) {
                        xhr.setRequestHeader('X-CSRF-Token', getCsrfToken());
                    }
                }
            });
        }

        // Store CSRF token for forms (fallback)
        window.CSRF_TOKEN = getCsrfToken();

        // =============================================
        // Global Toast Notification System
        // =============================================
        const ToastIcons = {
            success: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
            error: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
            warning: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
            info: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        };

        /**
         * Show a toast notification
         * @param {string} message - The message to display
         * @param {string} type - Type of toast: 'success', 'error', 'warning', 'info'
         * @param {number} duration - Duration in milliseconds (default: 4000)
         * @returns {HTMLElement} The toast element
         */
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return null;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');

            toast.innerHTML = `
                ${ToastIcons[type] || ToastIcons.info}
                <span class="toast-message">${escapeHtml(message)}</span>
                <button class="toast-close" aria-label="Dismiss notification" onclick="dismissToast(this.parentElement)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;

            container.appendChild(toast);

            // Announce to screen readers
            announceToScreenReader(message);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Auto dismiss
            if (duration > 0) {
                setTimeout(() => dismissToast(toast), duration);
            }

            return toast;
        }

        /**
         * Dismiss a toast notification
         * @param {HTMLElement} toast - The toast element to dismiss
         */
        function dismissToast(toast) {
            if (!toast || toast.classList.contains('hiding')) return;

            toast.classList.add('hiding');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        /**
         * Announce a message to screen readers
         * @param {string} message - The message to announce
         */
        function announceToScreenReader(message) {
            const liveRegion = document.getElementById('aria-live-region');
            if (liveRegion) {
                liveRegion.textContent = message;
                // Clear after a delay to allow re-announcement of same message
                setTimeout(() => { liveRegion.textContent = ''; }, 1000);
            }
        }

        /**
         * Escape HTML to prevent XSS
         * @param {string} str - String to escape
         * @returns {string} Escaped string
         */
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // =============================================
        // Keyboard Shortcuts
        // =============================================
        const keyboardShortcuts = {
            'KeyT': { description: 'Toggle training (on Forecast page)', handler: null },
            'KeyR': { description: 'Refresh data', handler: null },
            'Slash': { description: 'Focus search', handler: focusSearch },
            'Escape': { description: 'Close modal/dialog', handler: closeActiveModal }
        };

        function focusSearch() {
            const searchInputs = document.querySelectorAll('input[type="text"][placeholder*="Search"], input[type="search"]');
            if (searchInputs.length > 0) {
                searchInputs[0].focus();
                return true;
            }
            return false;
        }

        function closeActiveModal() {
            // Try to find and close any open modal
            const modals = document.querySelectorAll('[id*="modal"]:not(.hidden), [id*="Modal"]:not(.hidden)');
            modals.forEach(modal => {
                if (!modal.classList.contains('hidden') && modal.style.display !== 'none') {
                    modal.classList.add('hidden');
                }
            });
        }

        // Global keyboard shortcut listener
        document.addEventListener('keydown', function(e) {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                // But allow Escape to work
                if (e.code !== 'Escape') return;
            }

            const shortcut = keyboardShortcuts[e.code];
            if (shortcut && shortcut.handler && !e.ctrlKey && !e.metaKey && !e.altKey) {
                if (shortcut.handler()) {
                    e.preventDefault();
                }
            }
        });

        // Allow pages to register custom shortcuts
        window.registerKeyboardShortcut = function(code, description, handler) {
            keyboardShortcuts[code] = { description, handler };
        };

        // =============================================
        // Button Loading State Helpers
        // =============================================
        /**
         * Set a button to loading state
         * @param {HTMLElement|string} btn - Button element or selector
         * @param {string} loadingText - Text to show while loading
         */
        function setButtonLoading(btn, loadingText = 'Loading...') {
            if (typeof btn === 'string') {
                btn = document.querySelector(btn);
            }
            if (!btn) return;

            btn._originalContent = btn.innerHTML;
            btn._originalDisabled = btn.disabled;
            btn.disabled = true;
            btn.innerHTML = `
                <svg class="w-4 h-4 inline mr-1 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ${escapeHtml(loadingText)}
            `;
        }

        /**
         * Reset a button from loading state
         * @param {HTMLElement|string} btn - Button element or selector
         */
        function resetButtonLoading(btn) {
            if (typeof btn === 'string') {
                btn = document.querySelector(btn);
            }
            if (!btn || btn._originalContent === undefined) return;

            btn.innerHTML = btn._originalContent;
            btn.disabled = btn._originalDisabled;
            delete btn._originalContent;
            delete btn._originalDisabled;
        }

        // =============================================
        // Debounce Utility
        // =============================================
        /**
         * Debounce a function
         * @param {Function} func - Function to debounce
         * @param {number} wait - Wait time in milliseconds
         * @returns {Function} Debounced function
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Make utilities globally available
        window.showToast = showToast;
        window.dismissToast = dismissToast;
        window.announceToScreenReader = announceToScreenReader;
        window.setButtonLoading = setButtonLoading;
        window.resetButtonLoading = resetButtonLoading;
        window.debounce = debounce;

        // =============================================
        // Project Selector
        // =============================================
        const PROJECT_STORAGE_KEY = 'gmp_current_project_id';

        function getCurrentProjectId() {
            return localStorage.getItem(PROJECT_STORAGE_KEY) || '1';
        }

        function setCurrentProjectId(projectId) {
            localStorage.setItem(PROJECT_STORAGE_KEY, projectId);
            window.dispatchEvent(new CustomEvent('projectChanged', { detail: { projectId } }));
        }

        async function loadProjects() {
            const projectList = document.getElementById('project-list');
            const currentProjectName = document.getElementById('current-project-name');
            if (!projectList) return;

            try {
                const response = await fetch('/api/projects');
                if (!response.ok) throw new Error('Failed to load projects');
                const projects = await response.json();

                if (projects.length === 0) {
                    projectList.innerHTML = '<div class="text-sm text-gray-500 p-2">No projects found</div>';
                    return;
                }

                const currentId = getCurrentProjectId();
                let currentProject = projects.find(p => p.id.toString() === currentId) || projects[0];

                // Update button text
                if (currentProjectName) {
                    currentProjectName.textContent = currentProject.name;
                }

                // Build dropdown list
                projectList.innerHTML = projects.map(p => `
                    <button type="button"
                            class="w-full text-left px-3 py-2 text-sm rounded-md transition-colors
                                   ${p.id.toString() === currentId ? 'bg-indigo-50 text-indigo-700' : 'hover:bg-gray-100 text-gray-700'}"
                            data-project-id="${p.id}"
                            data-project-name="${escapeHtml(p.name)}">
                        <div class="flex items-center justify-between">
                            <span class="font-medium">${escapeHtml(p.name)}</span>
                            <span class="text-xs text-gray-400">${escapeHtml(p.code)}</span>
                        </div>
                        ${p.is_training_eligible ? '<span class="text-xs text-green-600">ML Enabled</span>' : ''}
                    </button>
                `).join('');

                // Add click handlers
                projectList.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const projectId = btn.dataset.projectId;
                        const projectName = btn.dataset.projectName;
                        setCurrentProjectId(projectId);
                        if (currentProjectName) currentProjectName.textContent = projectName;
                        document.getElementById('project-dropdown')?.classList.add('hidden');
                        // Reload page to reflect new project
                        window.location.reload();
                    });
                });

            } catch (error) {
                console.error('Error loading projects:', error);
                projectList.innerHTML = '<div class="text-sm text-red-500 p-2">Failed to load projects</div>';
            }
        }

        // Project selector dropdown toggle
        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('project-selector-btn');
            const dropdown = document.getElementById('project-dropdown');

            if (btn && dropdown) {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle('hidden');
                    if (!dropdown.classList.contains('hidden')) {
                        loadProjects();
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            }

            // Load initial project name
            loadProjects();
        });

        // Make project functions globally available
        window.getCurrentProjectId = getCurrentProjectId;
        window.setCurrentProjectId = setCurrentProjectId;
    </script>

    <!-- Footer -->
    <footer class="bg-white border-t mt-auto py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 text-sm">
                GMP Reconciliation App &copy; {{ now().year if now is defined else '2025' }}
            </p>
        </div>
    </footer>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
